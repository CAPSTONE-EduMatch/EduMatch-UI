#!/usr/bin/env sh
set -e

echo "ğŸ” Running pre-commit checks (type check + build + lint)..."

# --- Ensure PNPM is reachable (absolute path) ---
PNPM="$HOME/.local/share/pnpm/pnpm"

# --- Ensure NODE is reachable (Flatpak doesn't see host PATH) ---
add_to_path_if_has_node() {
  dir="$1"
  if [ -x "$dir/node" ]; then
    export PATH="$dir:$PATH"
    echo "â†’ using node at $dir/node"
    return 0
  fi
  return 1
}

# Try common locations (nvm, volta, asdf, system)
add_to_path_if_has_node "$HOME/.nvm/versions/node/$(ls -1 $HOME/.nvm/versions/node 2>/dev/null | tail -n1)/bin" ||
add_to_path_if_has_node "$HOME/.volta/bin" ||
add_to_path_if_has_node "$HOME/.asdf/shims" ||
add_to_path_if_has_node "/usr/bin" ||
{
  # As a last attempt, source nvm if present to set default
  if [ -s "$HOME/.nvm/nvm.sh" ]; then
    . "$HOME/.nvm/nvm.sh"
    nvm use default >/dev/null 2>&1 || true
  fi
}

# Final check
if ! command -v node >/dev/null 2>&1; then
  echo "âŒ 'node' not found in PATH (Flatpak GitKraken can't see your host Node)."
  echo "Fix: install Node in home (nvm/volta/asdf) or point to its bin dir."
  exit 127
fi

run_pm() {
  if [ -x "$PNPM" ]; then
    echo "â†’ using pnpm at $PNPM"
    "$PNPM" "$@"
  elif command -v pnpm >/dev/null 2>&1; then
    echo "â†’ using pnpm on PATH"
    pnpm "$@"
  else
    if [ "$1" = "exec" ]; then shift; echo "â†’ npx --no-install $*"; npx --no-install "$@"
    elif [ "$1" = "run" ]; then shift; echo "â†’ npm run $*"; npm run "$@"
    else echo "pnpm not available and no fallback for: $*"; exit 127; fi
  fi
}

echo "ğŸ”§ Building project..."
run_pm run pre-commit   # e.g. "next build && lint-staged" in package.json

echo "ğŸ•º Performing linting checks..."
run_pm exec lint-staged

echo "âœ… Your code is beautiful, nice job ğŸ‘"
