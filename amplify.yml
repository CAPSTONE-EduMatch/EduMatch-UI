version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Use npm install instead of npm ci for better caching
        - npm install --legacy-peer-deps
        # Create .env file more efficiently
        - |
          cat > .env << EOF
          DATABASE_URL=$DATABASE_URL
          BETTER_AUTH_SECRET=$BETTER_AUTH_SECRET
          BETTER_AUTH_URL=$BETTER_AUTH_URL
          GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
          GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
          STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY
          STRIPE_WEBHOOK_SECRET=$STRIPE_WEBHOOK_SECRET
          REDIS_URL=$REDIS_URL
          SMTP_HOST=$SMTP_HOST
          SMTP_PORT=$SMTP_PORT
          SMTP_USER=$SMTP_USER
          SMTP_PASS=$SMTP_PASS
          SMTP_FROM=$SMTP_FROM
          REGION=$REGION
          S3_BUCKET_NAME=$S3_BUCKET_NAME
          SECRET_ACCESS_KEY=$SECRET_ACCESS_KEY
          ACCESS_KEY_ID=$ACCESS_KEY_ID
          SQS_NOTIFICATIONS_QUEUE_URL=$SQS_NOTIFICATIONS_QUEUE_URL
          SQS_EMAILS_QUEUE_URL=$SQS_EMAILS_QUEUE_URL
          NEXT_PUBLIC_BETTER_AUTH_URL=$NEXT_PUBLIC_BETTER_AUTH_URL
          NEXT_PUBLIC_GOOGLE_CLIENT_ID=$NEXT_PUBLIC_GOOGLE_CLIENT_ID
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
          NEXT_PUBLIC_STRIPE_BASIC_PRICE_ID=$NEXT_PUBLIC_STRIPE_BASIC_PRICE_ID
          NEXT_PUBLIC_STRIPE_PRO_PRICE_ID=$NEXT_PUBLIC_STRIPE_PRO_PRICE_ID
          NEXT_PUBLIC_STRIPE_ENTERPRISE_PRICE_ID=$NEXT_PUBLIC_STRIPE_ENTERPRISE_PRICE_ID
          STRIPE_BASIC_PRICE_ID=$STRIPE_BASIC_PRICE_ID
          STRIPE_PRO_PRICE_ID=$STRIPE_PRO_PRICE_ID
          STRIPE_ENTERPRISE_PRICE_ID=$STRIPE_ENTERPRISE_PRICE_ID
          NEXT_PUBLIC_APPSYNC_ENDPOINT=$NEXT_PUBLIC_APPSYNC_ENDPOINT
          NEXT_PUBLIC_APPSYNC_API_KEY=$NEXT_PUBLIC_APPSYNC_API_KEY
          NEXT_PUBLIC_AWS_REGION=$NEXT_PUBLIC_AWS_REGION
          EOF
        - npx prisma generate
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - prisma/generated/**/*
  runtime:
    name: node
    version: 20
customHeaders:
  - pattern: '/api/files/s3-upload'
    headers:
      - key: 'Access-Control-Allow-Origin'
        value: '*'
      - key: 'Access-Control-Allow-Headers'
        value: 'Content-Type, Authorization'
      - key: 'Access-Control-Allow-Methods'
        value: 'POST, OPTIONS'
      - key: 'Access-Control-Max-Age'
        value: '86400'
  - pattern: '/api/**'
    headers:
      - key: 'X-Content-Type-Options'
        value: 'nosniff'
      - key: 'X-Frame-Options'
        value: 'DENY'
      - key: 'X-XSS-Protection'
        value: '1; mode=block'
