{
	"Description": "EduMatch SQS and Lambda infrastructure for notifications",
	"Resources": {
		"NotificationsDLQ7EE1DB27": {
			"Type": "AWS::SQS::Queue",
			"Properties": {
				"ContentBasedDeduplication": true,
				"FifoQueue": true,
				"MessageRetentionPeriod": 1209600,
				"QueueName": "edumatch-notifications-dlq.fifo"
			},
			"UpdateReplacePolicy": "Delete",
			"DeletionPolicy": "Delete",
			"Metadata": {
				"aws:cdk:path": "EduMatchNotificationStack/NotificationsDLQ/Resource"
			}
		},
		"NotificationsQueue3B766469": {
			"Type": "AWS::SQS::Queue",
			"Properties": {
				"ContentBasedDeduplication": true,
				"FifoQueue": true,
				"MessageRetentionPeriod": 1209600,
				"QueueName": "edumatch-notifications.fifo",
				"RedrivePolicy": {
					"deadLetterTargetArn": {
						"Fn::GetAtt": ["NotificationsDLQ7EE1DB27", "Arn"]
					},
					"maxReceiveCount": 3
				},
				"VisibilityTimeout": 300
			},
			"UpdateReplacePolicy": "Delete",
			"DeletionPolicy": "Delete",
			"Metadata": {
				"aws:cdk:path": "EduMatchNotificationStack/NotificationsQueue/Resource"
			}
		},
		"EmailsDLQ1B20FAB8": {
			"Type": "AWS::SQS::Queue",
			"Properties": {
				"ContentBasedDeduplication": true,
				"FifoQueue": true,
				"MessageRetentionPeriod": 1209600,
				"QueueName": "edumatch-emails-dlq.fifo"
			},
			"UpdateReplacePolicy": "Delete",
			"DeletionPolicy": "Delete",
			"Metadata": {
				"aws:cdk:path": "EduMatchNotificationStack/EmailsDLQ/Resource"
			}
		},
		"EmailsQueue3086DFE6": {
			"Type": "AWS::SQS::Queue",
			"Properties": {
				"ContentBasedDeduplication": true,
				"FifoQueue": true,
				"MessageRetentionPeriod": 1209600,
				"QueueName": "edumatch-emails.fifo",
				"RedrivePolicy": {
					"deadLetterTargetArn": {
						"Fn::GetAtt": ["EmailsDLQ1B20FAB8", "Arn"]
					},
					"maxReceiveCount": 3
				},
				"VisibilityTimeout": 300
			},
			"UpdateReplacePolicy": "Delete",
			"DeletionPolicy": "Delete",
			"Metadata": {
				"aws:cdk:path": "EduMatchNotificationStack/EmailsQueue/Resource"
			}
		},
		"NotificationLambdaRole8517A721": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Statement": [
						{
							"Action": "sts:AssumeRole",
							"Effect": "Allow",
							"Principal": {
								"Service": "lambda.amazonaws.com"
							}
						}
					],
					"Version": "2012-10-17"
				},
				"ManagedPolicyArns": [
					{
						"Fn::Join": [
							"",
							[
								"arn:",
								{
									"Ref": "AWS::Partition"
								},
								":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
							]
						]
					}
				],
				"Policies": [
					{
						"PolicyDocument": {
							"Statement": [
								{
									"Action": [
										"sqs:ChangeMessageVisibility",
										"sqs:DeleteMessage",
										"sqs:GetQueueAttributes",
										"sqs:ReceiveMessage"
									],
									"Effect": "Allow",
									"Resource": [
										{
											"Fn::GetAtt": [
												"EmailsDLQ1B20FAB8",
												"Arn"
											]
										},
										{
											"Fn::GetAtt": [
												"EmailsQueue3086DFE6",
												"Arn"
											]
										},
										{
											"Fn::GetAtt": [
												"NotificationsDLQ7EE1DB27",
												"Arn"
											]
										},
										{
											"Fn::GetAtt": [
												"NotificationsQueue3B766469",
												"Arn"
											]
										}
									]
								},
								{
									"Action": [
										"ses:SendEmail",
										"ses:SendRawEmail"
									],
									"Effect": "Allow",
									"Resource": "*"
								}
							],
							"Version": "2012-10-17"
						},
						"PolicyName": "SQSAndSESPolicy"
					}
				]
			},
			"Metadata": {
				"aws:cdk:path": "EduMatchNotificationStack/NotificationLambdaRole/Resource"
			}
		},
		"NotificationLambdaRoleDefaultPolicy07D18877": {
			"Type": "AWS::IAM::Policy",
			"Properties": {
				"PolicyDocument": {
					"Statement": [
						{
							"Action": [
								"sqs:ChangeMessageVisibility",
								"sqs:DeleteMessage",
								"sqs:GetQueueAttributes",
								"sqs:GetQueueUrl",
								"sqs:ReceiveMessage"
							],
							"Effect": "Allow",
							"Resource": [
								{
									"Fn::GetAtt": ["EmailsQueue3086DFE6", "Arn"]
								},
								{
									"Fn::GetAtt": [
										"NotificationsQueue3B766469",
										"Arn"
									]
								}
							]
						}
					],
					"Version": "2012-10-17"
				},
				"PolicyName": "NotificationLambdaRoleDefaultPolicy07D18877",
				"Roles": [
					{
						"Ref": "NotificationLambdaRole8517A721"
					}
				]
			},
			"Metadata": {
				"aws:cdk:path": "EduMatchNotificationStack/NotificationLambdaRole/DefaultPolicy/Resource"
			}
		},
		"NotificationProcessorLogGroup84C9CB83": {
			"Type": "AWS::Logs::LogGroup",
			"Properties": {
				"RetentionInDays": 7
			},
			"UpdateReplacePolicy": "Retain",
			"DeletionPolicy": "Retain",
			"Metadata": {
				"aws:cdk:path": "EduMatchNotificationStack/NotificationProcessorLogGroup/Resource"
			}
		},
		"NotificationProcessorE91924AA": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Code": {
					"ZipFile": "\nconst { SQSClient, SendMessageCommand } = require('@aws-sdk/client-sqs');\n\nconst sqsClient = new SQSClient({ region: 'ap-northeast-1' });\n\nexports.handler = async (event) => {\n  console.log('Processing notification messages:', JSON.stringify(event, null, 2));\n  \n  for (const record of event.Records) {\n    try {\n      const message = JSON.parse(record.body);\n      console.log('Processing notification:', message.type, 'for user:', message.userId);\n      \n      // Forward message to email queue\n      \n      const emailCommand = new SendMessageCommand({\n        QueueUrl: process.env.EMAILS_QUEUE_URL,\n        MessageBody: JSON.stringify(message),\n        MessageAttributes: {\n          Type: {\n            DataType: 'String',\n            StringValue: message.type,\n          },\n          UserEmail: {\n            DataType: 'String',\n            StringValue: message.userEmail,\n          },\n        },\n        MessageGroupId: message.userEmail,\n        MessageDeduplicationId: message.id,\n      });\n      \n      await sqsClient.send(emailCommand);\n      console.log('Message forwarded to email queue:', message.type, 'for:', message.userEmail);\n      \n    } catch (error) {\n      console.error('Error processing notification:', error);\n      throw error; // This will trigger retry\n    }\n  }\n};\n      "
				},
				"Environment": {
					"Variables": {
						"NOTIFICATIONS_QUEUE_URL": {
							"Ref": "NotificationsQueue3B766469"
						},
						"EMAILS_QUEUE_URL": {
							"Ref": "EmailsQueue3086DFE6"
						}
					}
				},
				"Handler": "index.handler",
				"LoggingConfig": {
					"LogGroup": {
						"Ref": "NotificationProcessorLogGroup84C9CB83"
					}
				},
				"MemorySize": 256,
				"Role": {
					"Fn::GetAtt": ["NotificationLambdaRole8517A721", "Arn"]
				},
				"Runtime": "nodejs18.x",
				"Timeout": 300
			},
			"DependsOn": [
				"NotificationLambdaRoleDefaultPolicy07D18877",
				"NotificationLambdaRole8517A721"
			],
			"Metadata": {
				"aws:cdk:path": "EduMatchNotificationStack/NotificationProcessor/Resource"
			}
		},
		"NotificationProcessorSqsEventSourceEduMatchNotificationStackNotificationsQueueD5B21BB63BAC48DC": {
			"Type": "AWS::Lambda::EventSourceMapping",
			"Properties": {
				"BatchSize": 10,
				"EventSourceArn": {
					"Fn::GetAtt": ["NotificationsQueue3B766469", "Arn"]
				},
				"FunctionName": {
					"Ref": "NotificationProcessorE91924AA"
				}
			},
			"Metadata": {
				"aws:cdk:path": "EduMatchNotificationStack/NotificationProcessor/SqsEventSource:EduMatchNotificationStackNotificationsQueueD5B21BB6/Resource"
			}
		},
		"EmailProcessorLogGroup8A79A2C8": {
			"Type": "AWS::Logs::LogGroup",
			"Properties": {
				"RetentionInDays": 7
			},
			"UpdateReplacePolicy": "Retain",
			"DeletionPolicy": "Retain",
			"Metadata": {
				"aws:cdk:path": "EduMatchNotificationStack/EmailProcessorLogGroup/Resource"
			}
		},
		"EmailProcessor218EC076": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Code": {
					"ZipFile": "\nconst { SQSClient, ReceiveMessageCommand, DeleteMessageCommand } = require('@aws-sdk/client-sqs');\nconst https = require('https');\n\nconst sqsClient = new SQSClient({ region: 'ap-northeast-1' });\n\n// Email templates (simplified versions)\nconst emailTemplates = {\n  WELCOME: (metadata) => ({\n    subject: `Welcome to EduMatch, ${metadata.firstName}!`,\n    html: `\n      <h1>Welcome to EduMatch!</h1>\n      <p>Hello ${metadata.firstName} ${metadata.lastName},</p>\n      <p>Welcome to EduMatch! We're thrilled to have you join our community.</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  PROFILE_CREATED: (metadata) => ({\n    subject: 'Profile Created Successfully - Welcome to EduMatch!',\n    html: `\n      <h1>Profile Created Successfully!</h1>\n      <p>Congratulations, ${metadata.firstName}!</p>\n      <p>Your ${metadata.role} profile has been successfully created.</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  PAYMENT_DEADLINE: (metadata) => ({\n    subject: `Payment Deadline Reminder - ${metadata.planName} Subscription`,\n    html: `\n      <h1>Payment Deadline Reminder</h1>\n      <p>Your ${metadata.planName} subscription payment is due soon.</p>\n      <p>Amount: ${metadata.currency} ${metadata.amount}</p>\n      <p>Deadline: ${new Date(metadata.deadlineDate).toLocaleDateString()}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  APPLICATION_STATUS_UPDATE: (metadata) => ({\n    subject: `Application Status Update - ${metadata.programName}`,\n    html: `\n      <h1>Application Status Update</h1>\n      <p>Your application to ${metadata.programName} at ${metadata.institutionName} has been updated.</p>\n      <p>New Status: ${metadata.newStatus}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  PAYMENT_SUCCESS: (metadata) => ({\n    subject: `Payment Successful - ${metadata.planName} Subscription`,\n    html: `\n      <h1>Payment Successful!</h1>\n      <p>Thank you for your payment.</p>\n      <p>Plan: ${metadata.planName}</p>\n      <p>Amount: ${metadata.currency} ${metadata.amount}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  PAYMENT_FAILED: (metadata) => ({\n    subject: `Payment Failed - ${metadata.planName} Subscription`,\n    html: `\n      <h1>Payment Failed</h1>\n      <p>We were unable to process your payment for ${metadata.planName}.</p>\n      <p>Reason: ${metadata.failureReason}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  SUBSCRIPTION_EXPIRING: (metadata) => ({\n    subject: `Subscription Expiring Soon - ${metadata.planName}`,\n    html: `\n      <h1>Subscription Expiring Soon</h1>\n      <p>Your ${metadata.planName} subscription will expire in ${metadata.daysRemaining} days.</p>\n      <p>Expiry Date: ${new Date(metadata.expiryDate).toLocaleDateString()}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  })\n};\n\nexports.handler = async (event) => {\n  console.log('Processing email messages:', JSON.stringify(event, null, 2));\n  \n  for (const record of event.Records) {\n    try {\n      const message = JSON.parse(record.body);\n      console.log('Processing email:', message.type, 'for:', message.userEmail);\n      \n      // Get email template\n      const template = emailTemplates[message.type];\n      if (!template) {\n        console.error('Unknown email type:', message.type);\n        continue;\n      }\n      \n      const emailContent = template(message.metadata);\n      \n      // Send email by calling your Next.js app's email API\n      const emailPayload = {\n        to: message.userEmail,\n        subject: emailContent.subject,\n        html: emailContent.html,\n        from: 'edumatch.noreply@gmail.com'\n      };\n      \n      // Call your Next.js app's email API endpoint\n      // Try localhost first (for development), then fallback to deployed URL\n      let baseUrl = 'http://localhost:3000';\n      try {\n        // Try localhost first\n        const localhostResponse = await fetch('http://localhost:3000/api/send-email', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify(emailPayload),\n          signal: AbortSignal.timeout(2000) // 2 second timeout\n        });\n        \n        if (localhostResponse.ok) {\n          const result = await localhostResponse.json();\n          console.log('Email sent successfully via localhost:', {\n            to: message.userEmail,\n            subject: emailContent.subject,\n            type: message.type,\n            messageId: result.messageId,\n            timestamp: new Date().toISOString()\n          });\n          continue; // Skip to next message\n        }\n      } catch (localhostError) {\n        console.log('Localhost not available, trying deployed URL...');\n      }\n      \n      // Fallback to deployed URL\n      baseUrl = 'https://dev.d1jaxpbx3axxsh.amplifyapp.com';\n      const response = await fetch('https://dev.d1jaxpbx3axxsh.amplifyapp.com/api/send-email', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(emailPayload)\n      });\n      \n      if (response.ok) {\n        const result = await response.json();\n        console.log('Email sent successfully via deployed URL:', {\n          to: message.userEmail,\n          subject: emailContent.subject,\n          type: message.type,\n          messageId: result.messageId,\n          timestamp: new Date().toISOString()\n        });\n      } else {\n        const errorData = await response.json();\n        console.error('Failed to send email via deployed URL:', response.status, errorData);\n        throw new Error(`Email sending failed: ${response.status} - ${errorData.error}`);\n      }\n      \n    } catch (error) {\n      console.error('Error processing email:', error);\n      throw error; // This will trigger retry\n    }\n  }\n};\n      "
				},
				"Handler": "index.handler",
				"LoggingConfig": {
					"LogGroup": {
						"Ref": "EmailProcessorLogGroup8A79A2C8"
					}
				},
				"MemorySize": 256,
				"Role": {
					"Fn::GetAtt": ["NotificationLambdaRole8517A721", "Arn"]
				},
				"Runtime": "nodejs18.x",
				"Timeout": 300
			},
			"DependsOn": [
				"NotificationLambdaRoleDefaultPolicy07D18877",
				"NotificationLambdaRole8517A721"
			],
			"Metadata": {
				"aws:cdk:path": "EduMatchNotificationStack/EmailProcessor/Resource"
			}
		},
		"EmailProcessorSqsEventSourceEduMatchNotificationStackEmailsQueueA17FD60A9634D804": {
			"Type": "AWS::Lambda::EventSourceMapping",
			"Properties": {
				"BatchSize": 10,
				"EventSourceArn": {
					"Fn::GetAtt": ["EmailsQueue3086DFE6", "Arn"]
				},
				"FunctionName": {
					"Ref": "EmailProcessor218EC076"
				}
			},
			"Metadata": {
				"aws:cdk:path": "EduMatchNotificationStack/EmailProcessor/SqsEventSource:EduMatchNotificationStackEmailsQueueA17FD60A/Resource"
			}
		},
		"CDKMetadata": {
			"Type": "AWS::CDK::Metadata",
			"Properties": {
				"Analytics": "v2:deflate64:H4sIAAAAAAAA/2WKQQ6CMBBFz+K+jNCda6NuNCocwJRSSaG0lXYgpundTSG6cfXfvDcUaLGDfMNml/Gmz5SsIVSe8Z6w2T2CezkIdxQoyP6pF4hEsgFCadTilr0ZJfk7nStFokzrIJxNexoN2lS+HIliQ90wCEfU3EujU/3xYRLaVwZHLi7MWqnblP9tjKQUbjHp4Yreoo9Em0ZA57YTpVAUkG86J2U2ovZyEFCu+wH4qiwy9gAAAA=="
			},
			"Metadata": {
				"aws:cdk:path": "EduMatchNotificationStack/CDKMetadata/Default"
			}
		}
	},
	"Outputs": {
		"NotificationsQueueUrl": {
			"Description": "SQS Notifications Queue URL",
			"Value": {
				"Ref": "NotificationsQueue3B766469"
			},
			"Export": {
				"Name": "EduMatch-NotificationsQueueUrl"
			}
		},
		"EmailsQueueUrl": {
			"Description": "SQS Emails Queue URL",
			"Value": {
				"Ref": "EmailsQueue3086DFE6"
			},
			"Export": {
				"Name": "EduMatch-EmailsQueueUrl"
			}
		},
		"NotificationProcessorArn": {
			"Description": "Notification Processor Lambda ARN",
			"Value": {
				"Fn::GetAtt": ["NotificationProcessorE91924AA", "Arn"]
			},
			"Export": {
				"Name": "EduMatch-NotificationProcessorArn"
			}
		},
		"EmailProcessorArn": {
			"Description": "Email Processor Lambda ARN",
			"Value": {
				"Fn::GetAtt": ["EmailProcessor218EC076", "Arn"]
			},
			"Export": {
				"Name": "EduMatch-EmailProcessorArn"
			}
		}
	},
	"Parameters": {
		"BootstrapVersion": {
			"Type": "AWS::SSM::Parameter::Value<String>",
			"Default": "/cdk-bootstrap/hnb659fds/version",
			"Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
		}
	},
	"Rules": {
		"CheckBootstrapVersion": {
			"Assertions": [
				{
					"Assert": {
						"Fn::Not": [
							{
								"Fn::Contains": [
									["1", "2", "3", "4", "5"],
									{
										"Ref": "BootstrapVersion"
									}
								]
							}
						]
					},
					"AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
				}
			]
		}
	}
}
