{
 "Description": "EduMatch SQS and Lambda infrastructure for notifications",
 "Resources": {
  "NotificationsDLQ7EE1DB27": {
   "Type": "AWS::SQS::Queue",
   "Properties": {
    "ContentBasedDeduplication": true,
    "FifoQueue": true,
    "MessageRetentionPeriod": 1209600,
    "QueueName": "edumatch-notifications-dlq.fifo"
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/NotificationsDLQ/Resource"
   }
  },
  "NotificationsQueue3B766469": {
   "Type": "AWS::SQS::Queue",
   "Properties": {
    "ContentBasedDeduplication": true,
    "FifoQueue": true,
    "MessageRetentionPeriod": 1209600,
    "QueueName": "edumatch-notifications.fifo",
    "RedrivePolicy": {
     "deadLetterTargetArn": {
      "Fn::GetAtt": [
       "NotificationsDLQ7EE1DB27",
       "Arn"
      ]
     },
     "maxReceiveCount": 3
    },
    "VisibilityTimeout": 300
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/NotificationsQueue/Resource"
   }
  },
  "EmailsDLQ1B20FAB8": {
   "Type": "AWS::SQS::Queue",
   "Properties": {
    "ContentBasedDeduplication": true,
    "FifoQueue": true,
    "MessageRetentionPeriod": 1209600,
    "QueueName": "edumatch-emails-dlq.fifo"
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EmailsDLQ/Resource"
   }
  },
  "EmailsQueue3086DFE6": {
   "Type": "AWS::SQS::Queue",
   "Properties": {
    "ContentBasedDeduplication": true,
    "FifoQueue": true,
    "MessageRetentionPeriod": 1209600,
    "QueueName": "edumatch-emails.fifo",
    "RedrivePolicy": {
     "deadLetterTargetArn": {
      "Fn::GetAtt": [
       "EmailsDLQ1B20FAB8",
       "Arn"
      ]
     },
     "maxReceiveCount": 3
    },
    "VisibilityTimeout": 300
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EmailsQueue/Resource"
   }
  },
  "NotificationLambdaRole8517A721": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ],
    "Policies": [
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": [
          "sqs:ChangeMessageVisibility",
          "sqs:DeleteMessage",
          "sqs:GetQueueAttributes",
          "sqs:ReceiveMessage"
         ],
         "Effect": "Allow",
         "Resource": [
          {
           "Fn::GetAtt": [
            "EmailsDLQ1B20FAB8",
            "Arn"
           ]
          },
          {
           "Fn::GetAtt": [
            "EmailsQueue3086DFE6",
            "Arn"
           ]
          },
          {
           "Fn::GetAtt": [
            "NotificationsDLQ7EE1DB27",
            "Arn"
           ]
          },
          {
           "Fn::GetAtt": [
            "NotificationsQueue3B766469",
            "Arn"
           ]
          }
         ]
        },
        {
         "Action": [
          "ses:SendEmail",
          "ses:SendRawEmail"
         ],
         "Effect": "Allow",
         "Resource": "*"
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": "SQSAndSESPolicy"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/NotificationLambdaRole/Resource"
   }
  },
  "NotificationLambdaRoleDefaultPolicy07D18877": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "sqs:ChangeMessageVisibility",
        "sqs:DeleteMessage",
        "sqs:GetQueueAttributes",
        "sqs:GetQueueUrl",
        "sqs:ReceiveMessage"
       ],
       "Effect": "Allow",
       "Resource": [
        {
         "Fn::GetAtt": [
          "EmailsQueue3086DFE6",
          "Arn"
         ]
        },
        {
         "Fn::GetAtt": [
          "NotificationsQueue3B766469",
          "Arn"
         ]
        }
       ]
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "NotificationLambdaRoleDefaultPolicy07D18877",
    "Roles": [
     {
      "Ref": "NotificationLambdaRole8517A721"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/NotificationLambdaRole/DefaultPolicy/Resource"
   }
  },
  "NotificationProcessorLogGroup84C9CB83": {
   "Type": "AWS::Logs::LogGroup",
   "Properties": {
    "RetentionInDays": 7
   },
   "UpdateReplacePolicy": "Retain",
   "DeletionPolicy": "Retain",
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/NotificationProcessorLogGroup/Resource"
   }
  },
  "NotificationProcessorE91924AA": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "ZipFile": "\nconst { SQSClient, SendMessageCommand } = require('@aws-sdk/client-sqs');\n\nconst sqsClient = new SQSClient({ region: 'ap-northeast-1' });\n\nexports.handler = async (event) => {\n  console.log('Processing notification messages:', JSON.stringify(event, null, 2));\n  \n  for (const record of event.Records) {\n    try {\n      const message = JSON.parse(record.body);\n      console.log('Processing notification:', message.type, 'for user:', message.userId);\n      \n      // Store notification in database\n      await storeNotificationInDatabase(message);\n      \n      // Forward message to email queue\n      const emailCommand = new SendMessageCommand({\n        QueueUrl: process.env.EMAILS_QUEUE_URL,\n        MessageBody: JSON.stringify(message),\n        MessageAttributes: {\n          Type: {\n            DataType: 'String',\n            StringValue: message.type,\n          },\n          UserEmail: {\n            DataType: 'String',\n            StringValue: message.userEmail,\n          },\n        },\n        MessageGroupId: message.userEmail,\n        MessageDeduplicationId: message.id,\n      });\n      \n      await sqsClient.send(emailCommand);\n      console.log('Message forwarded to email queue:', message.type, 'for:', message.userEmail);\n      \n    } catch (error) {\n      console.error('Error processing notification:', error);\n      throw error; // This will trigger retry\n    }\n  }\n};\n\nasync function storeNotificationInDatabase(message) {\n  try {\n    console.log('Storing notification in database:', message.type, 'for user:', message.userId);\n    \n    // Create notification title and body based on type\n    let title = \"\";\n    let bodyText = \"\";\n    let url = \"/\";\n\n    switch (message.type) {\n      case \"WELCOME\":\n        title = \"Welcome to EduMatch!\";\n        bodyText = `Welcome ${message.metadata?.firstName || \"User\"}! Your account has been created successfully.`;\n        url = \"/profile/create\";\n        break;\n      case \"PROFILE_CREATED\":\n        title = \"Profile Created Successfully!\";\n        bodyText = `Your ${message.metadata?.role || \"profile\"} profile has been created and is now live.`;\n        url = \"/profile/view\";\n        break;\n      case \"PAYMENT_DEADLINE\":\n        title = \"Payment Deadline Reminder\";\n        bodyText = `Your ${message.metadata?.planName || \"subscription\"} payment is due on ${message.metadata?.deadlineDate || \"soon\"}.`;\n        url = \"/pricing\";\n        break;\n      default:\n        title = \"New Notification\";\n        bodyText = \"You have a new notification from EduMatch.\";\n        break;\n    }\n\n    // Call your API to store notification\n    const response = await fetch(`${process.env.API_BASE_URL || 'https://your-app-url.com'}/api/notifications/store`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        id: message.id,\n        userId: message.userId,\n        type: message.type,\n        title,\n        bodyText,\n        url,\n        payload: message.metadata || {},\n        createAt: new Date().toISOString(),\n        queuedAt: new Date().toISOString(),\n        status: \"sent\",\n      }),\n    });\n\n    if (!response.ok) {\n      throw new Error(`Failed to store notification: ${response.status}`);\n    }\n\n    console.log('✅ Notification stored in database successfully');\n  } catch (error) {\n    console.error('❌ Error storing notification in database:', error);\n    throw error;\n  }\n}\n      "
    },
    "Environment": {
     "Variables": {
      "NOTIFICATIONS_QUEUE_URL": {
       "Ref": "NotificationsQueue3B766469"
      },
      "EMAILS_QUEUE_URL": {
       "Ref": "EmailsQueue3086DFE6"
      }
     }
    },
    "Handler": "index.handler",
    "LoggingConfig": {
     "LogGroup": {
      "Ref": "NotificationProcessorLogGroup84C9CB83"
     }
    },
    "MemorySize": 256,
    "Role": {
     "Fn::GetAtt": [
      "NotificationLambdaRole8517A721",
      "Arn"
     ]
    },
    "Runtime": "nodejs18.x",
    "Timeout": 300
   },
   "DependsOn": [
    "NotificationLambdaRoleDefaultPolicy07D18877",
    "NotificationLambdaRole8517A721"
   ],
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/NotificationProcessor/Resource"
   }
  },
  "NotificationProcessorSqsEventSourceEduMatchNotificationStackNotificationsQueueD5B21BB63BAC48DC": {
   "Type": "AWS::Lambda::EventSourceMapping",
   "Properties": {
    "BatchSize": 10,
    "EventSourceArn": {
     "Fn::GetAtt": [
      "NotificationsQueue3B766469",
      "Arn"
     ]
    },
    "FunctionName": {
     "Ref": "NotificationProcessorE91924AA"
    }
   },
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/NotificationProcessor/SqsEventSource:EduMatchNotificationStackNotificationsQueueD5B21BB6/Resource"
   }
  },
  "EmailProcessorLogGroup8A79A2C8": {
   "Type": "AWS::Logs::LogGroup",
   "Properties": {
    "RetentionInDays": 7
   },
   "UpdateReplacePolicy": "Retain",
   "DeletionPolicy": "Retain",
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EmailProcessorLogGroup/Resource"
   }
  },
  "EmailProcessor218EC076": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "ZipFile": "\nconst { SQSClient, ReceiveMessageCommand, DeleteMessageCommand } = require('@aws-sdk/client-sqs');\nconst https = require('https');\n\nconst sqsClient = new SQSClient({ region: 'ap-northeast-1' });\n\n// Email templates (simplified versions)\nconst emailTemplates = {\n  WELCOME: (metadata) => ({\n    subject: `Welcome to EduMatch, ${metadata.firstName}!`,\n    html: `\n      <h1>Welcome to EduMatch!</h1>\n      <p>Hello ${metadata.firstName} ${metadata.lastName},</p>\n      <p>Welcome to EduMatch! We're thrilled to have you join our community.</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  PROFILE_CREATED: (metadata) => ({\n    subject: 'Profile Created Successfully - Welcome to EduMatch!',\n    html: `\n      <h1>Profile Created Successfully!</h1>\n      <p>Congratulations, ${metadata.firstName}!</p>\n      <p>Your ${metadata.role} profile has been successfully created.</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  PAYMENT_DEADLINE: (metadata) => ({\n    subject: `Payment Deadline Reminder - ${metadata.planName} Subscription`,\n    html: `\n      <h1>Payment Deadline Reminder</h1>\n      <p>Your ${metadata.planName} subscription payment is due soon.</p>\n      <p>Amount: ${metadata.currency} ${metadata.amount}</p>\n      <p>Deadline: ${new Date(metadata.deadlineDate).toLocaleDateString()}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  APPLICATION_STATUS_UPDATE: (metadata) => ({\n    subject: `Application Status Update - ${metadata.programName}`,\n    html: `\n      <h1>Application Status Update</h1>\n      <p>Your application to ${metadata.programName} at ${metadata.institutionName} has been updated.</p>\n      <p>New Status: ${metadata.newStatus}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  PAYMENT_SUCCESS: (metadata) => ({\n    subject: `Payment Successful - ${metadata.planName} Subscription`,\n    html: `\n      <h1>Payment Successful!</h1>\n      <p>Thank you for your payment.</p>\n      <p>Plan: ${metadata.planName}</p>\n      <p>Amount: ${metadata.currency} ${metadata.amount}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  PAYMENT_FAILED: (metadata) => ({\n    subject: `Payment Failed - ${metadata.planName} Subscription`,\n    html: `\n      <h1>Payment Failed</h1>\n      <p>We were unable to process your payment for ${metadata.planName}.</p>\n      <p>Reason: ${metadata.failureReason}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  SUBSCRIPTION_EXPIRING: (metadata) => ({\n    subject: `Subscription Expiring Soon - ${metadata.planName}`,\n    html: `\n      <h1>Subscription Expiring Soon</h1>\n      <p>Your ${metadata.planName} subscription will expire in ${metadata.daysRemaining} days.</p>\n      <p>Expiry Date: ${new Date(metadata.expiryDate).toLocaleDateString()}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  })\n};\n\nexports.handler = async (event) => {\n  console.log('Processing email messages:', JSON.stringify(event, null, 2));\n  \n  for (const record of event.Records) {\n    try {\n      const message = JSON.parse(record.body);\n      console.log('Processing email:', message.type, 'for:', message.userEmail);\n      \n      // Get email template\n      const template = emailTemplates[message.type];\n      if (!template) {\n        console.error('Unknown email type:', message.type);\n        continue;\n      }\n      \n      const emailContent = template(message.metadata);\n      \n      // Send email by calling your Next.js app's email API\n      const emailPayload = {\n        to: message.userEmail,\n        subject: emailContent.subject,\n        html: emailContent.html,\n        from: 'edumatch.noreply@gmail.com'\n      };\n      \n      // Call your Next.js app's email API endpoint\n      // Try localhost first (for development), then fallback to deployed URL\n      let baseUrl = 'http://localhost:3000';\n      try {\n        // Try localhost first\n        const localhostResponse = await fetch('http://localhost:3000/api/send-email', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify(emailPayload),\n          signal: AbortSignal.timeout(2000) // 2 second timeout\n        });\n        \n        if (localhostResponse.ok) {\n          const result = await localhostResponse.json();\n          console.log('Email sent successfully via localhost:', {\n            to: message.userEmail,\n            subject: emailContent.subject,\n            type: message.type,\n            messageId: result.messageId,\n            timestamp: new Date().toISOString()\n          });\n          continue; // Skip to next message\n        }\n      } catch (localhostError) {\n        console.log('Localhost not available, trying deployed URL...');\n      }\n      \n      // Fallback to deployed URL\n      baseUrl = 'https://dev.d1jaxpbx3axxsh.amplifyapp.com';\n      const response = await fetch('https://dev.d1jaxpbx3axxsh.amplifyapp.com/api/send-email', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(emailPayload)\n      });\n      \n      if (response.ok) {\n        const result = await response.json();\n        console.log('Email sent successfully via deployed URL:', {\n          to: message.userEmail,\n          subject: emailContent.subject,\n          type: message.type,\n          messageId: result.messageId,\n          timestamp: new Date().toISOString()\n        });\n      } else {\n        const errorData = await response.json();\n        console.error('Failed to send email via deployed URL:', response.status, errorData);\n        throw new Error(`Email sending failed: ${response.status} - ${errorData.error}`);\n      }\n      \n    } catch (error) {\n      console.error('Error processing email:', error);\n      throw error; // This will trigger retry\n    }\n  }\n};\n      "
    },
    "Handler": "index.handler",
    "LoggingConfig": {
     "LogGroup": {
      "Ref": "EmailProcessorLogGroup8A79A2C8"
     }
    },
    "MemorySize": 256,
    "Role": {
     "Fn::GetAtt": [
      "NotificationLambdaRole8517A721",
      "Arn"
     ]
    },
    "Runtime": "nodejs18.x",
    "Timeout": 300
   },
   "DependsOn": [
    "NotificationLambdaRoleDefaultPolicy07D18877",
    "NotificationLambdaRole8517A721"
   ],
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EmailProcessor/Resource"
   }
  },
  "EmailProcessorSqsEventSourceEduMatchNotificationStackEmailsQueueA17FD60A9634D804": {
   "Type": "AWS::Lambda::EventSourceMapping",
   "Properties": {
    "BatchSize": 10,
    "EventSourceArn": {
     "Fn::GetAtt": [
      "EmailsQueue3086DFE6",
      "Arn"
     ]
    },
    "FunctionName": {
     "Ref": "EmailProcessor218EC076"
    }
   },
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EmailProcessor/SqsEventSource:EduMatchNotificationStackEmailsQueueA17FD60A/Resource"
   }
  },
  "MessagesTable05B58A27": {
   "Type": "AWS::DynamoDB::Table",
   "Properties": {
    "AttributeDefinitions": [
     {
      "AttributeName": "threadId",
      "AttributeType": "S"
     },
     {
      "AttributeName": "createdAt",
      "AttributeType": "S"
     }
    ],
    "BillingMode": "PAY_PER_REQUEST",
    "KeySchema": [
     {
      "AttributeName": "threadId",
      "KeyType": "HASH"
     },
     {
      "AttributeName": "createdAt",
      "KeyType": "RANGE"
     }
    ],
    "TableName": "edumatch-messages"
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/MessagesTable/Resource"
   }
  },
  "ThreadsTable1D5C607C": {
   "Type": "AWS::DynamoDB::Table",
   "Properties": {
    "AttributeDefinitions": [
     {
      "AttributeName": "id",
      "AttributeType": "S"
     }
    ],
    "BillingMode": "PAY_PER_REQUEST",
    "KeySchema": [
     {
      "AttributeName": "id",
      "KeyType": "HASH"
     }
    ],
    "TableName": "edumatch-threads"
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/ThreadsTable/Resource"
   }
  },
  "EduMatchMessagingApiBA77C261": {
   "Type": "AWS::AppSync::GraphQLApi",
   "Properties": {
    "AdditionalAuthenticationProviders": [
     {
      "AuthenticationType": "AMAZON_COGNITO_USER_POOLS",
      "UserPoolConfig": {
       "AwsRegion": "ap-northeast-1",
       "UserPoolId": "us-east-1_XXXXXXXXX"
      }
     }
    ],
    "AuthenticationType": "API_KEY",
    "Name": "EduMatchMessagingApi",
    "XrayEnabled": true
   },
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EduMatchMessagingApi/Resource"
   }
  },
  "EduMatchMessagingApiSchema41540462": {
   "Type": "AWS::AppSync::GraphQLSchema",
   "Properties": {
    "ApiId": {
     "Fn::GetAtt": [
      "EduMatchMessagingApiBA77C261",
      "ApiId"
     ]
    },
    "Definition": "type Message {\n\tid: ID!\n\tthreadId: ID!\n\tcontent: String\n\tsenderId: ID!\n\tsenderName: String!\n\tsenderImage: String\n\tfileUrl: String\n\tfileName: String\n\tfileSize: Int\n\tmimeType: String\n\tcreatedAt: String!\n\tisRead: Boolean!\n}\n\ntype Thread {\n\tid: ID!\n\tparticipants: [String!]!\n\tlastMessage: String\n\tlastMessageAt: String\n\tcreatedAt: String!\n\tupdatedAt: String!\n\t# Additional fields for complete thread display\n\totherParticipant: Participant\n\tlastMessageSender: Participant\n\tunreadCount: Int!\n\tlastMessageFileUrl: String\n\tlastMessageFileName: String\n\tlastMessageMimeType: String\n}\n\ntype Participant {\n\tid: ID!\n\tname: String!\n\temail: String!\n\timage: String\n}\n\ntype User {\n\tid: ID!\n\tname: String!\n\temail: String!\n\timage: String\n}\n\ninput CreateMessageInput {\n\tid: ID!\n\tthreadId: ID!\n\tcontent: String\n\tsenderId: ID!\n\tsenderName: String!\n\tsenderImage: String\n\tfileUrl: String\n\tfileName: String\n\tfileSize: Int\n\tmimeType: String\n\tcreatedAt: String!\n\tisRead: Boolean!\n}\n\ninput CreateThreadInput {\n\tid: ID!\n\tparticipants: [String!]!\n\tcreatedAt: String!\n\tupdatedAt: String!\n\t# Additional fields for complete thread creation\n\totherParticipant: ParticipantInput\n\tlastMessageSender: ParticipantInput\n\tunreadCount: Int!\n\tlastMessageFileUrl: String\n\tlastMessageFileName: String\n\tlastMessageMimeType: String\n}\n\ninput ParticipantInput {\n\tid: ID!\n\tname: String!\n\temail: String!\n\timage: String\n}\n\ninput UpdateThreadInput {\n\tid: ID!\n\tlastMessage: String\n\tlastMessageAt: String\n\tupdatedAt: String!\n\tlastMessageSender: ParticipantInput\n\tunreadCount: Int!\n\tlastMessageFileUrl: String\n\tlastMessageFileName: String\n\tlastMessageMimeType: String\n}\n\ntype Query {\n\tgetMessages(threadId: ID!): [Message!]!\n\tgetThreads: [Thread!]!\n\tgetThread(id: ID!): Thread\n}\n\ntype Mutation {\n\tcreateMessage(input: CreateMessageInput!): Message!\n\tcreateThread(input: CreateThreadInput!): Thread!\n\tupdateThread(input: UpdateThreadInput!): Thread!\n\tmarkMessageAsRead(messageId: ID!): Message!\n}\n\ntype Subscription {\n\tonMessageAdded(threadId: ID!): Message\n\t\t@aws_subscribe(mutations: [\"createMessage\"])\n\tonThreadUpdated: Thread\n\t\t@aws_subscribe(mutations: [\"createThread\", \"updateThread\"])\n}\n"
   },
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EduMatchMessagingApi/Schema"
   }
  },
  "EduMatchMessagingApiDefaultApiKey3C625F00": {
   "Type": "AWS::AppSync::ApiKey",
   "Properties": {
    "ApiId": {
     "Fn::GetAtt": [
      "EduMatchMessagingApiBA77C261",
      "ApiId"
     ]
    },
    "Expires": 1791812703
   },
   "DependsOn": [
    "EduMatchMessagingApiSchema41540462"
   ],
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EduMatchMessagingApi/DefaultApiKey"
   }
  },
  "EduMatchMessagingApiMessagesDataSourceServiceRole6F6DD6BC": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "appsync.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EduMatchMessagingApi/MessagesDataSource/ServiceRole/Resource"
   }
  },
  "EduMatchMessagingApiMessagesDataSourceServiceRoleDefaultPolicy0E47B253": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "dynamodb:BatchGetItem",
        "dynamodb:BatchWriteItem",
        "dynamodb:ConditionCheckItem",
        "dynamodb:DeleteItem",
        "dynamodb:DescribeTable",
        "dynamodb:GetItem",
        "dynamodb:GetRecords",
        "dynamodb:GetShardIterator",
        "dynamodb:PutItem",
        "dynamodb:Query",
        "dynamodb:Scan",
        "dynamodb:UpdateItem"
       ],
       "Effect": "Allow",
       "Resource": [
        {
         "Fn::GetAtt": [
          "MessagesTable05B58A27",
          "Arn"
         ]
        },
        {
         "Ref": "AWS::NoValue"
        }
       ]
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "EduMatchMessagingApiMessagesDataSourceServiceRoleDefaultPolicy0E47B253",
    "Roles": [
     {
      "Ref": "EduMatchMessagingApiMessagesDataSourceServiceRole6F6DD6BC"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EduMatchMessagingApi/MessagesDataSource/ServiceRole/DefaultPolicy/Resource"
   }
  },
  "EduMatchMessagingApiMessagesDataSourceF27C1361": {
   "Type": "AWS::AppSync::DataSource",
   "Properties": {
    "ApiId": {
     "Fn::GetAtt": [
      "EduMatchMessagingApiBA77C261",
      "ApiId"
     ]
    },
    "DynamoDBConfig": {
     "AwsRegion": "ap-northeast-1",
     "TableName": {
      "Ref": "MessagesTable05B58A27"
     }
    },
    "Name": "MessagesDataSource",
    "ServiceRoleArn": {
     "Fn::GetAtt": [
      "EduMatchMessagingApiMessagesDataSourceServiceRole6F6DD6BC",
      "Arn"
     ]
    },
    "Type": "AMAZON_DYNAMODB"
   },
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EduMatchMessagingApi/MessagesDataSource/Resource"
   }
  },
  "EduMatchMessagingApiThreadsDataSourceServiceRole5CD739A8": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "appsync.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EduMatchMessagingApi/ThreadsDataSource/ServiceRole/Resource"
   }
  },
  "EduMatchMessagingApiThreadsDataSourceServiceRoleDefaultPolicyA5DB5C43": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "dynamodb:BatchGetItem",
        "dynamodb:BatchWriteItem",
        "dynamodb:ConditionCheckItem",
        "dynamodb:DeleteItem",
        "dynamodb:DescribeTable",
        "dynamodb:GetItem",
        "dynamodb:GetRecords",
        "dynamodb:GetShardIterator",
        "dynamodb:PutItem",
        "dynamodb:Query",
        "dynamodb:Scan",
        "dynamodb:UpdateItem"
       ],
       "Effect": "Allow",
       "Resource": [
        {
         "Fn::GetAtt": [
          "ThreadsTable1D5C607C",
          "Arn"
         ]
        },
        {
         "Ref": "AWS::NoValue"
        }
       ]
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "EduMatchMessagingApiThreadsDataSourceServiceRoleDefaultPolicyA5DB5C43",
    "Roles": [
     {
      "Ref": "EduMatchMessagingApiThreadsDataSourceServiceRole5CD739A8"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EduMatchMessagingApi/ThreadsDataSource/ServiceRole/DefaultPolicy/Resource"
   }
  },
  "EduMatchMessagingApiThreadsDataSource61344A17": {
   "Type": "AWS::AppSync::DataSource",
   "Properties": {
    "ApiId": {
     "Fn::GetAtt": [
      "EduMatchMessagingApiBA77C261",
      "ApiId"
     ]
    },
    "DynamoDBConfig": {
     "AwsRegion": "ap-northeast-1",
     "TableName": {
      "Ref": "ThreadsTable1D5C607C"
     }
    },
    "Name": "ThreadsDataSource",
    "ServiceRoleArn": {
     "Fn::GetAtt": [
      "EduMatchMessagingApiThreadsDataSourceServiceRole5CD739A8",
      "Arn"
     ]
    },
    "Type": "AMAZON_DYNAMODB"
   },
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EduMatchMessagingApi/ThreadsDataSource/Resource"
   }
  },
  "EduMatchMessagingApiGetMessagesResolver33E0BB7B": {
   "Type": "AWS::AppSync::Resolver",
   "Properties": {
    "ApiId": {
     "Fn::GetAtt": [
      "EduMatchMessagingApiBA77C261",
      "ApiId"
     ]
    },
    "DataSourceName": "MessagesDataSource",
    "FieldName": "getMessages",
    "Kind": "UNIT",
    "RequestMappingTemplate": "\n\t\t\t\t{\n\t\t\t\t\t\"version\": \"2017-02-28\",\n\t\t\t\t\t\"operation\": \"Query\",\n\t\t\t\t\t\"query\": {\n\t\t\t\t\t\t\"expression\": \"threadId = :threadId\",\n\t\t\t\t\t\t\"expressionValues\": {\n\t\t\t\t\t\t\t\":threadId\": $util.dynamodb.toDynamoDBJson($ctx.args.threadId)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t",
    "ResponseMappingTemplate": "$util.toJson($ctx.result.items)",
    "TypeName": "Query"
   },
   "DependsOn": [
    "EduMatchMessagingApiMessagesDataSourceF27C1361",
    "EduMatchMessagingApiSchema41540462"
   ],
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EduMatchMessagingApi/GetMessagesResolver/Resource"
   }
  },
  "EduMatchMessagingApiCreateMessageResolverDCBC7BAC": {
   "Type": "AWS::AppSync::Resolver",
   "Properties": {
    "ApiId": {
     "Fn::GetAtt": [
      "EduMatchMessagingApiBA77C261",
      "ApiId"
     ]
    },
    "DataSourceName": "MessagesDataSource",
    "FieldName": "createMessage",
    "Kind": "UNIT",
    "RequestMappingTemplate": "\n\t\t\t\t{\n\t\t\t\t\t\"version\": \"2017-02-28\",\n\t\t\t\t\t\"operation\": \"PutItem\",\n\t\t\t\t\t\"key\": {\n\t\t\t\t\t\t\"threadId\": $util.dynamodb.toDynamoDBJson($ctx.args.input.threadId),\n\t\t\t\t\t\t\"createdAt\": $util.dynamodb.toDynamoDBJson($ctx.args.input.createdAt)\n\t\t\t\t\t},\n\t\t\t\t\t\"attributeValues\": $util.dynamodb.toMapValuesJson($ctx.args.input)\n\t\t\t\t}\n\t\t\t",
    "ResponseMappingTemplate": "$util.toJson($ctx.result)",
    "TypeName": "Mutation"
   },
   "DependsOn": [
    "EduMatchMessagingApiMessagesDataSourceF27C1361",
    "EduMatchMessagingApiSchema41540462"
   ],
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EduMatchMessagingApi/CreateMessageResolver/Resource"
   }
  },
  "EduMatchMessagingApiGetThreadsResolverE8D22243": {
   "Type": "AWS::AppSync::Resolver",
   "Properties": {
    "ApiId": {
     "Fn::GetAtt": [
      "EduMatchMessagingApiBA77C261",
      "ApiId"
     ]
    },
    "DataSourceName": "ThreadsDataSource",
    "FieldName": "getThreads",
    "Kind": "UNIT",
    "RequestMappingTemplate": "{\"version\" : \"2017-02-28\", \"operation\" : \"Scan\", \"consistentRead\": false}",
    "ResponseMappingTemplate": "$util.toJson($ctx.result.items)",
    "TypeName": "Query"
   },
   "DependsOn": [
    "EduMatchMessagingApiSchema41540462",
    "EduMatchMessagingApiThreadsDataSource61344A17"
   ],
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EduMatchMessagingApi/GetThreadsResolver/Resource"
   }
  },
  "EduMatchMessagingApiCreateThreadResolver2BE40D1D": {
   "Type": "AWS::AppSync::Resolver",
   "Properties": {
    "ApiId": {
     "Fn::GetAtt": [
      "EduMatchMessagingApiBA77C261",
      "ApiId"
     ]
    },
    "DataSourceName": "ThreadsDataSource",
    "FieldName": "createThread",
    "Kind": "UNIT",
    "RequestMappingTemplate": "\n\t\t\t\t{\n\t\t\t\t\t\"version\": \"2017-02-28\",\n\t\t\t\t\t\"operation\": \"PutItem\",\n\t\t\t\t\t\"key\": {\n\t\t\t\t\t\t\"id\": $util.dynamodb.toDynamoDBJson($ctx.args.input.id)\n\t\t\t\t\t},\n\t\t\t\t\t\"attributeValues\": $util.dynamodb.toMapValuesJson($ctx.args.input)\n\t\t\t\t}\n\t\t\t",
    "ResponseMappingTemplate": "$util.toJson($ctx.result)",
    "TypeName": "Mutation"
   },
   "DependsOn": [
    "EduMatchMessagingApiSchema41540462",
    "EduMatchMessagingApiThreadsDataSource61344A17"
   ],
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/EduMatchMessagingApi/CreateThreadResolver/Resource"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/2WPQW7DIBBFz5I9nsbedRnFbRZN1cTuvhowdUgwEAOOLMTdK3BTtepq3v8PMVBBVT7CeoU3W7DuUkhBIbQO2YXgzX4Ee7UQjp57TrafKkMkAgcIjZa5y/OgpWBzigtFInVvIex1vxu1N8ncORKJA+0QwrNXzAmtkv3hp4kr12o/Mv6KxgjVJ/2/jaSbFQ66oxDekS6PyRAJGmNnxSDsRjSnq9wYkWxOx/3f1LITHzAVGyNe+EzqfG1Na3S4bEzyV2q41XLiY/79N8eY6/vpN++Md5Eo3XE424epqqAsYb06WyGK0SsnBg7NMr8AcP06D4QBAAA="
   },
   "Metadata": {
    "aws:cdk:path": "EduMatchNotificationStack/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "NotificationsQueueUrl": {
   "Description": "SQS Notifications Queue URL",
   "Value": {
    "Ref": "NotificationsQueue3B766469"
   },
   "Export": {
    "Name": "EduMatch-NotificationsQueueUrl"
   }
  },
  "EmailsQueueUrl": {
   "Description": "SQS Emails Queue URL",
   "Value": {
    "Ref": "EmailsQueue3086DFE6"
   },
   "Export": {
    "Name": "EduMatch-EmailsQueueUrl"
   }
  },
  "NotificationProcessorArn": {
   "Description": "Notification Processor Lambda ARN",
   "Value": {
    "Fn::GetAtt": [
     "NotificationProcessorE91924AA",
     "Arn"
    ]
   },
   "Export": {
    "Name": "EduMatch-NotificationProcessorArn"
   }
  },
  "EmailProcessorArn": {
   "Description": "Email Processor Lambda ARN",
   "Value": {
    "Fn::GetAtt": [
     "EmailProcessor218EC076",
     "Arn"
    ]
   },
   "Export": {
    "Name": "EduMatch-EmailProcessorArn"
   }
  },
  "AppSyncApiEndpoint": {
   "Description": "AppSync GraphQL API Endpoint",
   "Value": {
    "Fn::GetAtt": [
     "EduMatchMessagingApiBA77C261",
     "GraphQLUrl"
    ]
   },
   "Export": {
    "Name": "EduMatch-AppSyncApiEndpoint"
   }
  },
  "AppSyncApiKey": {
   "Description": "AppSync API Key",
   "Value": {
    "Fn::GetAtt": [
     "EduMatchMessagingApiDefaultApiKey3C625F00",
     "ApiKey"
    ]
   },
   "Export": {
    "Name": "EduMatch-AppSyncApiKey"
   }
  },
  "MessagesTableName": {
   "Description": "Messages DynamoDB Table Name",
   "Value": {
    "Ref": "MessagesTable05B58A27"
   },
   "Export": {
    "Name": "EduMatch-MessagesTableName"
   }
  },
  "ThreadsTableName": {
   "Description": "Threads DynamoDB Table Name",
   "Value": {
    "Ref": "ThreadsTable1D5C607C"
   },
   "Export": {
    "Name": "EduMatch-ThreadsTableName"
   }
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}