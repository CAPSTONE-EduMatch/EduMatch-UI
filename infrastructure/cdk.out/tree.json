{"version":"tree-0.1","tree":{"id":"App","path":"","constructInfo":{"fqn":"aws-cdk-lib.App","version":"2.219.0"},"children":{"EduMatchNotificationStack":{"id":"EduMatchNotificationStack","path":"EduMatchNotificationStack","constructInfo":{"fqn":"aws-cdk-lib.Stack","version":"2.219.0"},"children":{"NotificationsDLQ":{"id":"NotificationsDLQ","path":"EduMatchNotificationStack/NotificationsDLQ","constructInfo":{"fqn":"aws-cdk-lib.aws_sqs.Queue","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/NotificationsDLQ/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_sqs.CfnQueue","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SQS::Queue","aws:cdk:cloudformation:props":{"contentBasedDeduplication":true,"fifoQueue":true,"messageRetentionPeriod":1209600,"queueName":"edumatch-notifications-dlq.fifo"}}}}},"NotificationsQueue":{"id":"NotificationsQueue","path":"EduMatchNotificationStack/NotificationsQueue","constructInfo":{"fqn":"aws-cdk-lib.aws_sqs.Queue","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/NotificationsQueue/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_sqs.CfnQueue","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SQS::Queue","aws:cdk:cloudformation:props":{"contentBasedDeduplication":true,"fifoQueue":true,"messageRetentionPeriod":1209600,"queueName":"edumatch-notifications.fifo","redrivePolicy":{"deadLetterTargetArn":{"Fn::GetAtt":["NotificationsDLQ7EE1DB27","Arn"]},"maxReceiveCount":3},"visibilityTimeout":300}}}}},"EmailsDLQ":{"id":"EmailsDLQ","path":"EduMatchNotificationStack/EmailsDLQ","constructInfo":{"fqn":"aws-cdk-lib.aws_sqs.Queue","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EmailsDLQ/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_sqs.CfnQueue","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SQS::Queue","aws:cdk:cloudformation:props":{"contentBasedDeduplication":true,"fifoQueue":true,"messageRetentionPeriod":1209600,"queueName":"edumatch-emails-dlq.fifo"}}}}},"EmailsQueue":{"id":"EmailsQueue","path":"EduMatchNotificationStack/EmailsQueue","constructInfo":{"fqn":"aws-cdk-lib.aws_sqs.Queue","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EmailsQueue/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_sqs.CfnQueue","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SQS::Queue","aws:cdk:cloudformation:props":{"contentBasedDeduplication":true,"fifoQueue":true,"messageRetentionPeriod":1209600,"queueName":"edumatch-emails.fifo","redrivePolicy":{"deadLetterTargetArn":{"Fn::GetAtt":["EmailsDLQ1B20FAB8","Arn"]},"maxReceiveCount":3},"visibilityTimeout":300}}}}},"NotificationLambdaRole":{"id":"NotificationLambdaRole","path":"EduMatchNotificationStack/NotificationLambdaRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.219.0","metadata":[]},"children":{"ImportNotificationLambdaRole":{"id":"ImportNotificationLambdaRole","path":"EduMatchNotificationStack/NotificationLambdaRole/ImportNotificationLambdaRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.219.0","metadata":[]}},"Resource":{"id":"Resource","path":"EduMatchNotificationStack/NotificationLambdaRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]]}],"policies":[{"policyName":"SQSAndSESPolicy","policyDocument":{"Statement":[{"Action":["sqs:ChangeMessageVisibility","sqs:DeleteMessage","sqs:GetQueueAttributes","sqs:ReceiveMessage"],"Effect":"Allow","Resource":[{"Fn::GetAtt":["EmailsDLQ1B20FAB8","Arn"]},{"Fn::GetAtt":["EmailsQueue3086DFE6","Arn"]},{"Fn::GetAtt":["NotificationsDLQ7EE1DB27","Arn"]},{"Fn::GetAtt":["NotificationsQueue3B766469","Arn"]}]},{"Action":["ses:SendEmail","ses:SendRawEmail"],"Effect":"Allow","Resource":"*"}],"Version":"2012-10-17"}}]}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"EduMatchNotificationStack/NotificationLambdaRole/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/NotificationLambdaRole/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["sqs:ChangeMessageVisibility","sqs:DeleteMessage","sqs:GetQueueAttributes","sqs:GetQueueUrl","sqs:ReceiveMessage"],"Effect":"Allow","Resource":[{"Fn::GetAtt":["EmailsQueue3086DFE6","Arn"]},{"Fn::GetAtt":["NotificationsQueue3B766469","Arn"]}]}],"Version":"2012-10-17"},"policyName":"NotificationLambdaRoleDefaultPolicy07D18877","roles":[{"Ref":"NotificationLambdaRole8517A721"}]}}}}}}},"NotificationProcessorLogGroup":{"id":"NotificationProcessorLogGroup","path":"EduMatchNotificationStack/NotificationProcessorLogGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.LogGroup","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/NotificationProcessorLogGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.CfnLogGroup","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Logs::LogGroup","aws:cdk:cloudformation:props":{"retentionInDays":7}}}}},"NotificationProcessor":{"id":"NotificationProcessor","path":"EduMatchNotificationStack/NotificationProcessor","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.Function","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/NotificationProcessor/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.CfnFunction","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::Function","aws:cdk:cloudformation:props":{"code":{"zipFile":"\nconst { SQSClient, SendMessageCommand } = require('@aws-sdk/client-sqs');\n\nconst sqsClient = new SQSClient({ region: 'ap-northeast-1' });\n\nexports.handler = async (event) => {\n  console.log('Processing notification messages:', JSON.stringify(event, null, 2));\n  \n  for (const record of event.Records) {\n    try {\n      const message = JSON.parse(record.body);\n      console.log('Processing notification:', message.type, 'for user:', message.userId);\n      \n      // Store notification in database\n      await storeNotificationInDatabase(message);\n      \n      // Forward message to email queue\n      const emailCommand = new SendMessageCommand({\n        QueueUrl: process.env.EMAILS_QUEUE_URL,\n        MessageBody: JSON.stringify(message),\n        MessageAttributes: {\n          Type: {\n            DataType: 'String',\n            StringValue: message.type,\n          },\n          UserEmail: {\n            DataType: 'String',\n            StringValue: message.userEmail,\n          },\n        },\n        MessageGroupId: message.userEmail,\n        MessageDeduplicationId: message.id,\n      });\n      \n      await sqsClient.send(emailCommand);\n      console.log('Message forwarded to email queue:', message.type, 'for:', message.userEmail);\n      \n    } catch (error) {\n      console.error('Error processing notification:', error);\n      throw error; // This will trigger retry\n    }\n  }\n};\n\nasync function storeNotificationInDatabase(message) {\n  try {\n    console.log('Storing notification in database:', message.type, 'for user:', message.userId);\n    \n    // Create notification title and body based on type\n    let title = \"\";\n    let bodyText = \"\";\n    let url = \"/\";\n\n    switch (message.type) {\n      case \"WELCOME\":\n        title = \"Welcome to EduMatch!\";\n        bodyText = `Welcome ${message.metadata?.firstName || \"User\"}! Your account has been created successfully.`;\n        url = \"/profile/create\";\n        break;\n      case \"PROFILE_CREATED\":\n        title = \"Profile Created Successfully!\";\n        bodyText = `Your ${message.metadata?.role || \"profile\"} profile has been created and is now live.`;\n        url = \"/profile/view\";\n        break;\n      case \"PAYMENT_DEADLINE\":\n        title = \"Payment Deadline Reminder\";\n        bodyText = `Your ${message.metadata?.planName || \"subscription\"} payment is due on ${message.metadata?.deadlineDate || \"soon\"}.`;\n        url = \"/pricing\";\n        break;\n      default:\n        title = \"New Notification\";\n        bodyText = \"You have a new notification from EduMatch.\";\n        break;\n    }\n\n    // Call your API to store notification\n    const response = await fetch(`${process.env.API_BASE_URL || 'https://your-app-url.com'}/api/notifications/store`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        id: message.id,\n        userId: message.userId,\n        type: message.type,\n        title,\n        bodyText,\n        url,\n        payload: message.metadata || {},\n        createAt: new Date().toISOString(),\n        queuedAt: new Date().toISOString(),\n        status: \"sent\",\n      }),\n    });\n\n    if (!response.ok) {\n      throw new Error(`Failed to store notification: ${response.status}`);\n    }\n\n    console.log('✅ Notification stored in database successfully');\n  } catch (error) {\n    console.error('❌ Error storing notification in database:', error);\n    throw error;\n  }\n}\n      "},"environment":{"variables":{"NOTIFICATIONS_QUEUE_URL":{"Ref":"NotificationsQueue3B766469"},"EMAILS_QUEUE_URL":{"Ref":"EmailsQueue3086DFE6"}}},"handler":"index.handler","loggingConfig":{"logGroup":{"Ref":"NotificationProcessorLogGroup84C9CB83"}},"memorySize":256,"role":{"Fn::GetAtt":["NotificationLambdaRole8517A721","Arn"]},"runtime":"nodejs18.x","timeout":300}}},"SqsEventSource:EduMatchNotificationStackNotificationsQueueD5B21BB6":{"id":"SqsEventSource:EduMatchNotificationStackNotificationsQueueD5B21BB6","path":"EduMatchNotificationStack/NotificationProcessor/SqsEventSource:EduMatchNotificationStackNotificationsQueueD5B21BB6","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.EventSourceMapping","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/NotificationProcessor/SqsEventSource:EduMatchNotificationStackNotificationsQueueD5B21BB6/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.CfnEventSourceMapping","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::EventSourceMapping","aws:cdk:cloudformation:props":{"batchSize":10,"eventSourceArn":{"Fn::GetAtt":["NotificationsQueue3B766469","Arn"]},"functionName":{"Ref":"NotificationProcessorE91924AA"}}}}}}}},"EmailProcessorLogGroup":{"id":"EmailProcessorLogGroup","path":"EduMatchNotificationStack/EmailProcessorLogGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.LogGroup","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EmailProcessorLogGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.CfnLogGroup","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Logs::LogGroup","aws:cdk:cloudformation:props":{"retentionInDays":7}}}}},"EmailProcessor":{"id":"EmailProcessor","path":"EduMatchNotificationStack/EmailProcessor","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.Function","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EmailProcessor/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.CfnFunction","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::Function","aws:cdk:cloudformation:props":{"code":{"zipFile":"\nconst { SQSClient, ReceiveMessageCommand, DeleteMessageCommand } = require('@aws-sdk/client-sqs');\nconst https = require('https');\n\nconst sqsClient = new SQSClient({ region: 'ap-northeast-1' });\n\n// Email templates (simplified versions)\nconst emailTemplates = {\n  WELCOME: (metadata) => ({\n    subject: `Welcome to EduMatch, ${metadata.firstName}!`,\n    html: `\n      <h1>Welcome to EduMatch!</h1>\n      <p>Hello ${metadata.firstName} ${metadata.lastName},</p>\n      <p>Welcome to EduMatch! We're thrilled to have you join our community.</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  PROFILE_CREATED: (metadata) => ({\n    subject: 'Profile Created Successfully - Welcome to EduMatch!',\n    html: `\n      <h1>Profile Created Successfully!</h1>\n      <p>Congratulations, ${metadata.firstName}!</p>\n      <p>Your ${metadata.role} profile has been successfully created.</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  PAYMENT_DEADLINE: (metadata) => ({\n    subject: `Payment Deadline Reminder - ${metadata.planName} Subscription`,\n    html: `\n      <h1>Payment Deadline Reminder</h1>\n      <p>Your ${metadata.planName} subscription payment is due soon.</p>\n      <p>Amount: ${metadata.currency} ${metadata.amount}</p>\n      <p>Deadline: ${new Date(metadata.deadlineDate).toLocaleDateString()}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  APPLICATION_STATUS_UPDATE: (metadata) => ({\n    subject: `Application Status Update - ${metadata.programName}`,\n    html: `\n      <h1>Application Status Update</h1>\n      <p>Your application to ${metadata.programName} at ${metadata.institutionName} has been updated.</p>\n      <p>New Status: ${metadata.newStatus}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  PAYMENT_SUCCESS: (metadata) => ({\n    subject: `Payment Successful - ${metadata.planName} Subscription`,\n    html: `\n      <h1>Payment Successful!</h1>\n      <p>Thank you for your payment.</p>\n      <p>Plan: ${metadata.planName}</p>\n      <p>Amount: ${metadata.currency} ${metadata.amount}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  PAYMENT_FAILED: (metadata) => ({\n    subject: `Payment Failed - ${metadata.planName} Subscription`,\n    html: `\n      <h1>Payment Failed</h1>\n      <p>We were unable to process your payment for ${metadata.planName}.</p>\n      <p>Reason: ${metadata.failureReason}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  }),\n  SUBSCRIPTION_EXPIRING: (metadata) => ({\n    subject: `Subscription Expiring Soon - ${metadata.planName}`,\n    html: `\n      <h1>Subscription Expiring Soon</h1>\n      <p>Your ${metadata.planName} subscription will expire in ${metadata.daysRemaining} days.</p>\n      <p>Expiry Date: ${new Date(metadata.expiryDate).toLocaleDateString()}</p>\n      <p>Best regards,<br>The EduMatch Team</p>\n    `\n  })\n};\n\nexports.handler = async (event) => {\n  console.log('Processing email messages:', JSON.stringify(event, null, 2));\n  \n  for (const record of event.Records) {\n    try {\n      const message = JSON.parse(record.body);\n      console.log('Processing email:', message.type, 'for:', message.userEmail);\n      \n      // Get email template\n      const template = emailTemplates[message.type];\n      if (!template) {\n        console.error('Unknown email type:', message.type);\n        continue;\n      }\n      \n      const emailContent = template(message.metadata);\n      \n      // Send email by calling your Next.js app's email API\n      const emailPayload = {\n        to: message.userEmail,\n        subject: emailContent.subject,\n        html: emailContent.html,\n        from: 'edumatch.noreply@gmail.com'\n      };\n      \n      // Call your Next.js app's email API endpoint\n      // Try localhost first (for development), then fallback to deployed URL\n      let baseUrl = 'http://localhost:3000';\n      try {\n        // Try localhost first\n        const localhostResponse = await fetch('http://localhost:3000/api/send-email', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify(emailPayload),\n          signal: AbortSignal.timeout(2000) // 2 second timeout\n        });\n        \n        if (localhostResponse.ok) {\n          const result = await localhostResponse.json();\n          console.log('Email sent successfully via localhost:', {\n            to: message.userEmail,\n            subject: emailContent.subject,\n            type: message.type,\n            messageId: result.messageId,\n            timestamp: new Date().toISOString()\n          });\n          continue; // Skip to next message\n        }\n      } catch (localhostError) {\n        console.log('Localhost not available, trying deployed URL...');\n      }\n      \n      // Fallback to deployed URL\n      baseUrl = 'https://dev.d1jaxpbx3axxsh.amplifyapp.com';\n      const response = await fetch('https://dev.d1jaxpbx3axxsh.amplifyapp.com/api/send-email', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(emailPayload)\n      });\n      \n      if (response.ok) {\n        const result = await response.json();\n        console.log('Email sent successfully via deployed URL:', {\n          to: message.userEmail,\n          subject: emailContent.subject,\n          type: message.type,\n          messageId: result.messageId,\n          timestamp: new Date().toISOString()\n        });\n      } else {\n        const errorData = await response.json();\n        console.error('Failed to send email via deployed URL:', response.status, errorData);\n        throw new Error(`Email sending failed: ${response.status} - ${errorData.error}`);\n      }\n      \n    } catch (error) {\n      console.error('Error processing email:', error);\n      throw error; // This will trigger retry\n    }\n  }\n};\n      "},"handler":"index.handler","loggingConfig":{"logGroup":{"Ref":"EmailProcessorLogGroup8A79A2C8"}},"memorySize":256,"role":{"Fn::GetAtt":["NotificationLambdaRole8517A721","Arn"]},"runtime":"nodejs18.x","timeout":300}}},"SqsEventSource:EduMatchNotificationStackEmailsQueueA17FD60A":{"id":"SqsEventSource:EduMatchNotificationStackEmailsQueueA17FD60A","path":"EduMatchNotificationStack/EmailProcessor/SqsEventSource:EduMatchNotificationStackEmailsQueueA17FD60A","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.EventSourceMapping","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EmailProcessor/SqsEventSource:EduMatchNotificationStackEmailsQueueA17FD60A/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.CfnEventSourceMapping","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::EventSourceMapping","aws:cdk:cloudformation:props":{"batchSize":10,"eventSourceArn":{"Fn::GetAtt":["EmailsQueue3086DFE6","Arn"]},"functionName":{"Ref":"EmailProcessor218EC076"}}}}}}}},"MessagesTable":{"id":"MessagesTable","path":"EduMatchNotificationStack/MessagesTable","constructInfo":{"fqn":"aws-cdk-lib.aws_dynamodb.Table","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/MessagesTable/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_dynamodb.CfnTable","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::DynamoDB::Table","aws:cdk:cloudformation:props":{"attributeDefinitions":[{"attributeName":"threadId","attributeType":"S"},{"attributeName":"createdAt","attributeType":"S"}],"billingMode":"PAY_PER_REQUEST","keySchema":[{"attributeName":"threadId","keyType":"HASH"},{"attributeName":"createdAt","keyType":"RANGE"}],"tableName":"edumatch-messages"}}},"ScalingRole":{"id":"ScalingRole","path":"EduMatchNotificationStack/MessagesTable/ScalingRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.219.0","metadata":[]}}}},"ThreadsTable":{"id":"ThreadsTable","path":"EduMatchNotificationStack/ThreadsTable","constructInfo":{"fqn":"aws-cdk-lib.aws_dynamodb.Table","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/ThreadsTable/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_dynamodb.CfnTable","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::DynamoDB::Table","aws:cdk:cloudformation:props":{"attributeDefinitions":[{"attributeName":"id","attributeType":"S"}],"billingMode":"PAY_PER_REQUEST","keySchema":[{"attributeName":"id","keyType":"HASH"}],"tableName":"edumatch-threads"}}},"ScalingRole":{"id":"ScalingRole","path":"EduMatchNotificationStack/ThreadsTable/ScalingRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.219.0","metadata":[]}}}},"UserPool":{"id":"UserPool","path":"EduMatchNotificationStack/UserPool","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.219.0","metadata":[]}},"EduMatchMessagingApi":{"id":"EduMatchMessagingApi","path":"EduMatchNotificationStack/EduMatchMessagingApi","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.GraphqlApi","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EduMatchMessagingApi/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.CfnGraphQLApi","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::AppSync::GraphQLApi","aws:cdk:cloudformation:props":{"additionalAuthenticationProviders":[{"authenticationType":"AMAZON_COGNITO_USER_POOLS","userPoolConfig":{"userPoolId":"us-east-1_XXXXXXXXX","awsRegion":"ap-northeast-1","defaultAction":"ALLOW"}}],"authenticationType":"API_KEY","name":"EduMatchMessagingApi","xrayEnabled":true}}},"Schema":{"id":"Schema","path":"EduMatchNotificationStack/EduMatchMessagingApi/Schema","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.CfnGraphQLSchema","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::AppSync::GraphQLSchema","aws:cdk:cloudformation:props":{"apiId":{"Fn::GetAtt":["EduMatchMessagingApiBA77C261","ApiId"]},"definition":"type Message {\n\tid: ID!\n\tthreadId: ID!\n\tcontent: String\n\tsenderId: ID!\n\tsenderName: String!\n\tsenderImage: String\n\tfileUrl: String\n\tfileName: String\n\tfileSize: Int\n\tmimeType: String\n\tcreatedAt: String!\n\tisRead: Boolean!\n}\n\ntype Thread {\n\tid: ID!\n\tparticipants: [String!]!\n\tlastMessage: String\n\tlastMessageAt: String\n\tcreatedAt: String!\n\tupdatedAt: String!\n\t# Additional fields for complete thread display\n\totherParticipant: Participant\n\tlastMessageSender: Participant\n\tunreadCount: Int!\n\tlastMessageFileUrl: String\n\tlastMessageFileName: String\n\tlastMessageMimeType: String\n}\n\ntype Participant {\n\tid: ID!\n\tname: String!\n\temail: String!\n\timage: String\n}\n\ntype User {\n\tid: ID!\n\tname: String!\n\temail: String!\n\timage: String\n}\n\ninput CreateMessageInput {\n\tid: ID!\n\tthreadId: ID!\n\tcontent: String\n\tsenderId: ID!\n\tsenderName: String!\n\tsenderImage: String\n\tfileUrl: String\n\tfileName: String\n\tfileSize: Int\n\tmimeType: String\n\tcreatedAt: String!\n\tisRead: Boolean!\n}\n\ninput CreateThreadInput {\n\tid: ID!\n\tparticipants: [String!]!\n\tcreatedAt: String!\n\tupdatedAt: String!\n\t# Additional fields for complete thread creation\n\totherParticipant: ParticipantInput\n\tlastMessageSender: ParticipantInput\n\tunreadCount: Int!\n\tlastMessageFileUrl: String\n\tlastMessageFileName: String\n\tlastMessageMimeType: String\n}\n\ninput ParticipantInput {\n\tid: ID!\n\tname: String!\n\temail: String!\n\timage: String\n}\n\ninput UpdateThreadInput {\n\tid: ID!\n\tlastMessage: String\n\tlastMessageAt: String\n\tupdatedAt: String!\n\tlastMessageSender: ParticipantInput\n\tunreadCount: Int!\n\tlastMessageFileUrl: String\n\tlastMessageFileName: String\n\tlastMessageMimeType: String\n}\n\ntype Query {\n\tgetMessages(threadId: ID!): [Message!]!\n\tgetThreads: [Thread!]!\n\tgetThread(id: ID!): Thread\n}\n\ntype Mutation {\n\tcreateMessage(input: CreateMessageInput!): Message!\n\tcreateThread(input: CreateThreadInput!): Thread!\n\tupdateThread(input: UpdateThreadInput!): Thread!\n\tmarkMessageAsRead(messageId: ID!): Message!\n}\n\ntype Subscription {\n\tonMessageAdded(threadId: ID!): Message\n\t\t@aws_subscribe(mutations: [\"createMessage\"])\n\tonThreadUpdated: Thread\n\t\t@aws_subscribe(mutations: [\"createThread\", \"updateThread\"])\n}\n"}}},"DefaultApiKey":{"id":"DefaultApiKey","path":"EduMatchNotificationStack/EduMatchMessagingApi/DefaultApiKey","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.CfnApiKey","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::AppSync::ApiKey","aws:cdk:cloudformation:props":{"apiId":{"Fn::GetAtt":["EduMatchMessagingApiBA77C261","ApiId"]},"expires":1791812703}}},"LogGroup":{"id":"LogGroup","path":"EduMatchNotificationStack/EduMatchMessagingApi/LogGroup","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.219.0","metadata":[]}},"MessagesDataSource":{"id":"MessagesDataSource","path":"EduMatchNotificationStack/EduMatchMessagingApi/MessagesDataSource","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.DynamoDbDataSource","version":"2.219.0"},"children":{"ServiceRole":{"id":"ServiceRole","path":"EduMatchNotificationStack/EduMatchMessagingApi/MessagesDataSource/ServiceRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.219.0","metadata":[]},"children":{"ImportServiceRole":{"id":"ImportServiceRole","path":"EduMatchNotificationStack/EduMatchMessagingApi/MessagesDataSource/ServiceRole/ImportServiceRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.219.0","metadata":[]}},"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EduMatchMessagingApi/MessagesDataSource/ServiceRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"appsync.amazonaws.com"}}],"Version":"2012-10-17"}}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"EduMatchNotificationStack/EduMatchMessagingApi/MessagesDataSource/ServiceRole/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EduMatchMessagingApi/MessagesDataSource/ServiceRole/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["dynamodb:BatchGetItem","dynamodb:BatchWriteItem","dynamodb:ConditionCheckItem","dynamodb:DeleteItem","dynamodb:DescribeTable","dynamodb:GetItem","dynamodb:GetRecords","dynamodb:GetShardIterator","dynamodb:PutItem","dynamodb:Query","dynamodb:Scan","dynamodb:UpdateItem"],"Effect":"Allow","Resource":[{"Fn::GetAtt":["MessagesTable05B58A27","Arn"]},{"Ref":"AWS::NoValue"}]}],"Version":"2012-10-17"},"policyName":"EduMatchMessagingApiMessagesDataSourceServiceRoleDefaultPolicy0E47B253","roles":[{"Ref":"EduMatchMessagingApiMessagesDataSourceServiceRole6F6DD6BC"}]}}}}}}},"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EduMatchMessagingApi/MessagesDataSource/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.CfnDataSource","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::AppSync::DataSource","aws:cdk:cloudformation:props":{"apiId":{"Fn::GetAtt":["EduMatchMessagingApiBA77C261","ApiId"]},"dynamoDbConfig":{"tableName":{"Ref":"MessagesTable05B58A27"},"awsRegion":"ap-northeast-1"},"name":"MessagesDataSource","serviceRoleArn":{"Fn::GetAtt":["EduMatchMessagingApiMessagesDataSourceServiceRole6F6DD6BC","Arn"]},"type":"AMAZON_DYNAMODB"}}}}},"ThreadsDataSource":{"id":"ThreadsDataSource","path":"EduMatchNotificationStack/EduMatchMessagingApi/ThreadsDataSource","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.DynamoDbDataSource","version":"2.219.0"},"children":{"ServiceRole":{"id":"ServiceRole","path":"EduMatchNotificationStack/EduMatchMessagingApi/ThreadsDataSource/ServiceRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.219.0","metadata":[]},"children":{"ImportServiceRole":{"id":"ImportServiceRole","path":"EduMatchNotificationStack/EduMatchMessagingApi/ThreadsDataSource/ServiceRole/ImportServiceRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.219.0","metadata":[]}},"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EduMatchMessagingApi/ThreadsDataSource/ServiceRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"appsync.amazonaws.com"}}],"Version":"2012-10-17"}}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"EduMatchNotificationStack/EduMatchMessagingApi/ThreadsDataSource/ServiceRole/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"2.219.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EduMatchMessagingApi/ThreadsDataSource/ServiceRole/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["dynamodb:BatchGetItem","dynamodb:BatchWriteItem","dynamodb:ConditionCheckItem","dynamodb:DeleteItem","dynamodb:DescribeTable","dynamodb:GetItem","dynamodb:GetRecords","dynamodb:GetShardIterator","dynamodb:PutItem","dynamodb:Query","dynamodb:Scan","dynamodb:UpdateItem"],"Effect":"Allow","Resource":[{"Fn::GetAtt":["ThreadsTable1D5C607C","Arn"]},{"Ref":"AWS::NoValue"}]}],"Version":"2012-10-17"},"policyName":"EduMatchMessagingApiThreadsDataSourceServiceRoleDefaultPolicyA5DB5C43","roles":[{"Ref":"EduMatchMessagingApiThreadsDataSourceServiceRole5CD739A8"}]}}}}}}},"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EduMatchMessagingApi/ThreadsDataSource/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.CfnDataSource","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::AppSync::DataSource","aws:cdk:cloudformation:props":{"apiId":{"Fn::GetAtt":["EduMatchMessagingApiBA77C261","ApiId"]},"dynamoDbConfig":{"tableName":{"Ref":"ThreadsTable1D5C607C"},"awsRegion":"ap-northeast-1"},"name":"ThreadsDataSource","serviceRoleArn":{"Fn::GetAtt":["EduMatchMessagingApiThreadsDataSourceServiceRole5CD739A8","Arn"]},"type":"AMAZON_DYNAMODB"}}}}},"GetMessagesResolver":{"id":"GetMessagesResolver","path":"EduMatchNotificationStack/EduMatchMessagingApi/GetMessagesResolver","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.Resolver","version":"2.219.0"},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EduMatchMessagingApi/GetMessagesResolver/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.CfnResolver","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::AppSync::Resolver","aws:cdk:cloudformation:props":{"apiId":{"Fn::GetAtt":["EduMatchMessagingApiBA77C261","ApiId"]},"dataSourceName":"MessagesDataSource","fieldName":"getMessages","kind":"UNIT","requestMappingTemplate":"\n\t\t\t\t{\n\t\t\t\t\t\"version\": \"2017-02-28\",\n\t\t\t\t\t\"operation\": \"Query\",\n\t\t\t\t\t\"query\": {\n\t\t\t\t\t\t\"expression\": \"threadId = :threadId\",\n\t\t\t\t\t\t\"expressionValues\": {\n\t\t\t\t\t\t\t\":threadId\": $util.dynamodb.toDynamoDBJson($ctx.args.threadId)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t","responseMappingTemplate":"$util.toJson($ctx.result.items)","typeName":"Query"}}}}},"CreateMessageResolver":{"id":"CreateMessageResolver","path":"EduMatchNotificationStack/EduMatchMessagingApi/CreateMessageResolver","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.Resolver","version":"2.219.0"},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EduMatchMessagingApi/CreateMessageResolver/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.CfnResolver","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::AppSync::Resolver","aws:cdk:cloudformation:props":{"apiId":{"Fn::GetAtt":["EduMatchMessagingApiBA77C261","ApiId"]},"dataSourceName":"MessagesDataSource","fieldName":"createMessage","kind":"UNIT","requestMappingTemplate":"\n\t\t\t\t{\n\t\t\t\t\t\"version\": \"2017-02-28\",\n\t\t\t\t\t\"operation\": \"PutItem\",\n\t\t\t\t\t\"key\": {\n\t\t\t\t\t\t\"threadId\": $util.dynamodb.toDynamoDBJson($ctx.args.input.threadId),\n\t\t\t\t\t\t\"createdAt\": $util.dynamodb.toDynamoDBJson($ctx.args.input.createdAt)\n\t\t\t\t\t},\n\t\t\t\t\t\"attributeValues\": $util.dynamodb.toMapValuesJson($ctx.args.input)\n\t\t\t\t}\n\t\t\t","responseMappingTemplate":"$util.toJson($ctx.result)","typeName":"Mutation"}}}}},"GetThreadsResolver":{"id":"GetThreadsResolver","path":"EduMatchNotificationStack/EduMatchMessagingApi/GetThreadsResolver","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.Resolver","version":"2.219.0"},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EduMatchMessagingApi/GetThreadsResolver/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.CfnResolver","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::AppSync::Resolver","aws:cdk:cloudformation:props":{"apiId":{"Fn::GetAtt":["EduMatchMessagingApiBA77C261","ApiId"]},"dataSourceName":"ThreadsDataSource","fieldName":"getThreads","kind":"UNIT","requestMappingTemplate":"{\"version\" : \"2017-02-28\", \"operation\" : \"Scan\", \"consistentRead\": false}","responseMappingTemplate":"$util.toJson($ctx.result.items)","typeName":"Query"}}}}},"CreateThreadResolver":{"id":"CreateThreadResolver","path":"EduMatchNotificationStack/EduMatchMessagingApi/CreateThreadResolver","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.Resolver","version":"2.219.0"},"children":{"Resource":{"id":"Resource","path":"EduMatchNotificationStack/EduMatchMessagingApi/CreateThreadResolver/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_appsync.CfnResolver","version":"2.219.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::AppSync::Resolver","aws:cdk:cloudformation:props":{"apiId":{"Fn::GetAtt":["EduMatchMessagingApiBA77C261","ApiId"]},"dataSourceName":"ThreadsDataSource","fieldName":"createThread","kind":"UNIT","requestMappingTemplate":"\n\t\t\t\t{\n\t\t\t\t\t\"version\": \"2017-02-28\",\n\t\t\t\t\t\"operation\": \"PutItem\",\n\t\t\t\t\t\"key\": {\n\t\t\t\t\t\t\"id\": $util.dynamodb.toDynamoDBJson($ctx.args.input.id)\n\t\t\t\t\t},\n\t\t\t\t\t\"attributeValues\": $util.dynamodb.toMapValuesJson($ctx.args.input)\n\t\t\t\t}\n\t\t\t","responseMappingTemplate":"$util.toJson($ctx.result)","typeName":"Mutation"}}}}}}},"NotificationsQueueUrl":{"id":"NotificationsQueueUrl","path":"EduMatchNotificationStack/NotificationsQueueUrl","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.219.0"}},"EmailsQueueUrl":{"id":"EmailsQueueUrl","path":"EduMatchNotificationStack/EmailsQueueUrl","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.219.0"}},"NotificationProcessorArn":{"id":"NotificationProcessorArn","path":"EduMatchNotificationStack/NotificationProcessorArn","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.219.0"}},"EmailProcessorArn":{"id":"EmailProcessorArn","path":"EduMatchNotificationStack/EmailProcessorArn","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.219.0"}},"AppSyncApiEndpoint":{"id":"AppSyncApiEndpoint","path":"EduMatchNotificationStack/AppSyncApiEndpoint","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.219.0"}},"AppSyncApiKey":{"id":"AppSyncApiKey","path":"EduMatchNotificationStack/AppSyncApiKey","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.219.0"}},"MessagesTableName":{"id":"MessagesTableName","path":"EduMatchNotificationStack/MessagesTableName","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.219.0"}},"ThreadsTableName":{"id":"ThreadsTableName","path":"EduMatchNotificationStack/ThreadsTableName","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.219.0"}},"CDKMetadata":{"id":"CDKMetadata","path":"EduMatchNotificationStack/CDKMetadata","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"Default":{"id":"Default","path":"EduMatchNotificationStack/CDKMetadata/Default","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.219.0"}}}},"BootstrapVersion":{"id":"BootstrapVersion","path":"EduMatchNotificationStack/BootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnParameter","version":"2.219.0"}},"CheckBootstrapVersion":{"id":"CheckBootstrapVersion","path":"EduMatchNotificationStack/CheckBootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnRule","version":"2.219.0"}}}},"Tree":{"id":"Tree","path":"Tree","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}}}}