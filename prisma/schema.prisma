generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model user {
  /// PK - Better Auth required fields
  id             String               @id @default(uuid())
  name           String?
  email          String               @unique
  emailVerified  Boolean              @default(false)
  image          String?
  createdAt      DateTime             @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime             @updatedAt @db.Timestamptz(6)
  
  // Better Auth additional fields
  role           String?              // For Better Auth admin plugin
  banned         Boolean?             @default(false) // For Better Auth admin plugin
  stripeCustomerId String?            // For Better Auth Stripe plugin
  
  // Custom fields for your EduMatch app
  password       String?              // For email/password auth
  role_id        String?
  status         Boolean?             @default(true)
  
  // Relations
  userRole       Role?                @relation(fields: [role_id], references: [role_id], onDelete: NoAction, onUpdate: NoAction)
  applicant      Applicant?
  boxesAsUserOne Box[]                @relation("BoxUserOne")
  boxesAsUserTwo Box[]                @relation("BoxUserTwo")
  institution    Institution?
  notifications  Notification[]
  notifySetting  NotificationSetting?
  userManagement UserManagement[]
  // Better Auth relations
  accounts       account[]
  sessions       session[]

  @@map("user")
}

model account {
  id                      String    @id @default(uuid())
  userId                  String
  accountId               String
  providerId              String
  accessToken             String?   @db.Text
  refreshToken            String?   @db.Text
  accessTokenExpiresAt    DateTime? @db.Timestamptz(6)
  refreshTokenExpiresAt   DateTime? @db.Timestamptz(6)
  scope                   String?
  idToken                 String?   @db.Text
  password                String?
  createdAt               DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt               DateTime  @updatedAt @db.Timestamptz(6)
  user                    user      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("account")
}

model session {
  id           String    @id @default(uuid())
  userId       String
  token        String    @unique
  expiresAt    DateTime  @db.Timestamptz(6)
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @db.Timestamptz(6)
  user         user      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @db.Timestamptz(6)

  @@map("verification")
}

model Role {
  role_id  String    @id
  name     String
  status   Boolean
  users    user[]

  @@map("Role")
}

model Applicant {
  applicant_id        String                  @id
  first_name          String?
  last_name           String?
  birthday            DateTime?               @db.Date
  gender              Boolean?
  nationality         String?
  phone_number        String?
  graduated           Boolean?
  level               String?
  subdiscipline_id    String?
  gpa                 Decimal?                @db.Decimal
  user_id             String                  @unique
  user                user                    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subdiscipline       Subdiscipline?          @relation(fields: [subdiscipline_id], references: [subdiscipline_id])
  documents           ApplicantDocument[]
  interests           ApplicantInterest[]
  subscriptions       ApplicantSubscription[]
  applications        Application[]
  supportRequirements SupportRequirement[]
  wishlists           Wishlist[]

  @@map("Applicant")
}

model Institution {
  institution_id      String                     @id
  name                String
  abbreviation        String?
  hotline             String
  type                String
  country             String
  address             String
  rep_name            String
  rep_position        String
  rep_email           String
  rep_phone           String
  about               String
  user_id             String                     @unique
  user                user                       @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  documents           InstitutionDocument[]
  subdisciplines      InstitutionSubdiscipline[]
  subscriptions       InstitutionSubscription[]
  posts               OpportunityPost[]
  supportRequirements SupportRequirement[]

  @@map("Institution")
}

model Discipline {
  discipline_id  String          @id
  name           String
  status         Boolean
  subdisciplines Subdiscipline[]

  @@map("Discipline")
}

model Subdiscipline {
  subdiscipline_id   String                     @id
  name               String
  status             Boolean
  discipline_id      String
  applicants         Applicant[]
  applicantInterests ApplicantInterest[]
  institutionLinks   InstitutionSubdiscipline[]
  postLinks          PostSubdiscipline[]
  discipline         Discipline                 @relation(fields: [discipline_id], references: [discipline_id], onDelete: NoAction, onUpdate: NoAction)

  @@map("Subdiscipline")
}

model DocumentType {
  document_type_id   String                @id
  name               String
  description        String?
  applicantDocs      ApplicantDocument[]
  applicationDetails ApplicationDetail[]
  institutionDocs    InstitutionDocument[]
  postDocs           PostDocument[]

  @@map("DocumentType")
}

model OpportunityPost {
  post_id         String              @id
  title           String
  start_date      DateTime            @db.Timestamptz(6)
  end_date        DateTime?           @db.Timestamptz(6)
  location        String?
  other_info      String?
  status          PostStatus          @default(DRAFT)
  update_at       DateTime?           @db.Timestamptz(6)
  create_at       DateTime            @db.Timestamptz(6)
  institution_id  String             
  applications    Application[]
  jobPost         JobPost?
  institution     Institution         @relation(fields: [institution_id], references: [institution_id], onDelete: NoAction, onUpdate: NoAction)
  postDocs        PostDocument[]
  postManagement  PostManagement[]
  subdisciplines  PostSubdiscipline[]
  programPost     ProgramPost?
  scholarshipPost ScholarshipPost?
  wishlists       Wishlist[]

  @@index([institution_id])
  @@index([status])
  @@index([create_at])
  @@index([start_date, end_date])
  @@map("OpportunityPost")
}

model ProgramPost {
  post_id          String            @id
  duration         String
  degree_level     String
  attendance       String
  course_include   String?
  gpa              Decimal?          @db.Decimal
  gre              Int?
  gmat             Int?
  tuition_fee      Decimal?          @db.Decimal
  fee_description  String?
  scholarship_info String?
  certificates     PostCertificate[]
  post             OpportunityPost   @relation(fields: [post_id], references: [post_id], onDelete: NoAction, onUpdate: NoAction)

  @@map("ProgramPost")
}

model JobPost {
  post_id                   String          @id
  contract_type             String
  attendance                String
  job_type                  String
  min_salary                Decimal?        @db.Decimal
  max_salary                Decimal?        @db.Decimal
  salary_description        String?
  benefit                   String?
  main_responsibility       String?
  qualification_requirement String?
  experience_requirement    String?
  assessment_criteria       String?
  other_requirement         String?
  post                      OpportunityPost @relation(fields: [post_id], references: [post_id], onDelete: NoAction, onUpdate: NoAction)

  @@map("JobPost")
}

model ScholarshipPost {
  post_id              String          @id
  description          String
  type                 String
  number               Int
  grant                String?
  scholarship_coverage String?
  essay_required       Boolean?
  eligibility          String?
  post                 OpportunityPost @relation(fields: [post_id], references: [post_id], onDelete: NoAction, onUpdate: NoAction)

  @@map("ScholarshipPost")
}

model PostCertificate {
  certificate_id String      @id
  post_id        String     
  name           String
  score          String
  program        ProgramPost @relation(fields: [post_id], references: [post_id], onDelete: NoAction, onUpdate: NoAction)

  @@map("PostCertificate")
}

model PostDocument {
  document_id      String         
  post_id          String         
  document_type_id String         
  name             String
  description      String?
  documentType     DocumentType    @relation(fields: [document_type_id], references: [document_type_id], onDelete: NoAction, onUpdate: NoAction)
  post             OpportunityPost @relation(fields: [post_id], references: [post_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([document_id, post_id])
  @@map("PostDocument")
}

model PostSubdiscipline {
  subdiscipline_id String         
  post_id          String         
  add_at           DateTime        @db.Timestamptz(6)
  post             OpportunityPost @relation(fields: [post_id], references: [post_id], onDelete: NoAction, onUpdate: NoAction)
  subdiscipline    Subdiscipline   @relation(fields: [subdiscipline_id], references: [subdiscipline_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([subdiscipline_id, post_id])
  @@map("PostSubdiscipline")
}

model ApplicantDocument {
  document_id      String       @id
  applicant_id     String      
  document_type_id String      
  name             String
  url              String
  size             Int
  upload_at        DateTime     @db.Timestamptz(6)
  applicant        Applicant    @relation(fields: [applicant_id], references: [applicant_id], onDelete: NoAction, onUpdate: NoAction)
  documentType     DocumentType @relation(fields: [document_type_id], references: [document_type_id], onDelete: NoAction, onUpdate: NoAction)

  @@map("ApplicantDocument")
}

model InstitutionDocument {
  document_id      String       @id
  institution_id   String      
  document_type_id String      
  name             String
  url              String
  size             Int
  upload_at        DateTime     @db.Timestamptz(6)
  documentType     DocumentType @relation(fields: [document_type_id], references: [document_type_id], onDelete: NoAction, onUpdate: NoAction)
  institution      Institution  @relation(fields: [institution_id], references: [institution_id], onDelete: NoAction, onUpdate: NoAction)

  @@map("InstitutionDocument")
}

model ApplicantInterest {
  applicant_id     String       
  subdiscipline_id String       
  add_at           DateTime      @db.Timestamptz(6)
  applicant        Applicant     @relation(fields: [applicant_id], references: [applicant_id], onDelete: NoAction, onUpdate: NoAction)
  subdiscipline    Subdiscipline @relation(fields: [subdiscipline_id], references: [subdiscipline_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([applicant_id, subdiscipline_id])
  @@map("ApplicantInterest")
}

model Wishlist {
  applicant_id String         
  post_id      String         
  add_at       DateTime        @db.Timestamptz(6)
  applicant    Applicant       @relation(fields: [applicant_id], references: [applicant_id], onDelete: NoAction, onUpdate: NoAction)
  post         OpportunityPost @relation(fields: [post_id], references: [post_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([applicant_id, post_id])
  @@index([applicant_id])
  @@index([post_id])
  @@map("Wishlist")
}

model Application {
  application_id String              @id
  applicant_id   String             
  apply_at       DateTime            @db.Timestamptz(6)
  post_id        String             
  status         ApplicationStatus   @default(PENDING)
  applicant      Applicant           @relation(fields: [applicant_id], references: [applicant_id], onDelete: NoAction, onUpdate: NoAction)
  post           OpportunityPost     @relation(fields: [post_id], references: [post_id], onDelete: NoAction, onUpdate: NoAction)
  details        ApplicationDetail[]

  @@index([applicant_id])
  @@index([post_id])
  @@index([status])
  @@index([apply_at])
  @@map("Application")
}

model ApplicationDetail {
  document_id      String       @id
  document_type_id String      
  application_id   String      
  update_at        DateTime?    @db.Timestamptz(6)
  url              String
  name             String
  size             Int
  application      Application  @relation(fields: [application_id], references: [application_id], onDelete: NoAction, onUpdate: NoAction)
  documentType     DocumentType @relation(fields: [document_type_id], references: [document_type_id], onDelete: NoAction, onUpdate: NoAction)

  @@map("ApplicationDetail")
}

model NotificationSetting {
  user_id             String   @id
  notify_application  Boolean
  notify_wishlist     Boolean?
  notify_subscription Boolean
  update_at           DateTime @db.Timestamptz(6)
  user                user     @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("NotificationSetting")
}

model Notification {
  notification_id String    @id
  user_id         String   
  type            String
  title           String
  body            String
  url             String?
  send_at         DateTime  @db.Timestamptz(6)
  read_at         DateTime? @db.Timestamptz(6)
  user            user      @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([user_id])
  @@index([send_at])
  @@index([read_at])
  @@map("Notification")
}

model Box {
  box_id                        String    @id
  user_one_id                   String   
  user_two_id                   String   
  last_message_at               DateTime? @db.Timestamptz(6)
  created_at                    DateTime  @db.Timestamptz(6)
  updated_at                    DateTime  @db.Timestamptz(6)
  last_message_id               String?   @unique
  user_one_last_read_message_id String?  
  user_two_last_read_message_id String?  
  lastMessage                   Message?  @relation("LastMessage", fields: [last_message_id], references: [message_id])
  userOne                       user      @relation("BoxUserOne", fields: [user_one_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  userTwo                       user      @relation("BoxUserTwo", fields: [user_two_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  messages                      Message[]

  @@map("Box")
}

model Message {
  box_id         String  
  message_id     String   @id
  sender_id      String  
  body           String
  send_at        DateTime @db.Timestamptz(6)
  boxLastMessage Box?     @relation("LastMessage")
  box            Box      @relation(fields: [box_id], references: [box_id], onDelete: NoAction, onUpdate: NoAction)

  @@map("Message")
}

model Plan {
  plan_id         String                    @id
  name            String
  description     String?
  month_price     Int?
  year_price      Int?
  status          Boolean
  create_at       DateTime                  @db.Timestamptz(6)
  type            Boolean
  applicantSubs   ApplicantSubscription[]
  institutionSubs InstitutionSubscription[]
  planMgmt        PlanManagement[]

  @@map("Plan")
}

model ApplicantSubscription {
  subscription_id String             @id
  applicant_id    String            
  plan_id         String            
  status          SubscriptionStatus @default(ACTIVE)
  subscribe_at    DateTime           @default(now()) @db.Timestamptz(6)
  applicant       Applicant          @relation(fields: [applicant_id], references: [applicant_id], onDelete: NoAction, onUpdate: NoAction)
  plan            Plan               @relation(fields: [plan_id], references: [plan_id], onDelete: NoAction, onUpdate: NoAction)
  stripe          StripePayment      @relation(fields: [subscription_id], references: [subscription_id])

  @@map("ApplicantSubscription")
}

model InstitutionSubscription {
  subscription_id String             @id
  plan_id         String            
  institution_id  String            
  status          SubscriptionStatus @default(ACTIVE)
  subscribe_at    DateTime           @default(now()) @db.Timestamptz(6)
  institution     Institution        @relation(fields: [institution_id], references: [institution_id], onDelete: NoAction, onUpdate: NoAction)
  plan            Plan               @relation(fields: [plan_id], references: [plan_id], onDelete: NoAction, onUpdate: NoAction)
  stripe          StripePayment      @relation(fields: [subscription_id], references: [subscription_id])

  @@map("InstitutionSubscription")
}

// General subscription model for Better Auth
model subscription {
  id                   String    @id @default(uuid())
  referenceId          String?   // User ID reference
  stripeSubscriptionId String?   @unique
  stripeCustomerId     String?
  plan                 String?
  status               String?   @default("active")
  periodStart          DateTime? @db.Timestamptz(6)
  periodEnd            DateTime? @db.Timestamptz(6)
  cancelAtPeriodEnd    Boolean?  @default(false)
  seats                Int?      @default(1)
  createdAt            DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @db.Timestamptz(6)

  @@map("subscription")
}

model StripePayment {
  stripeSubscriptionId String                   @id
  subscription_id      String                   @unique
  stripeCustomerId     String                   @unique
  periodStart          DateTime?                @db.Timestamptz(6)
  periodEnd            DateTime?                @db.Timestamptz(6)
  cancelAtPeriodEnd    Boolean?                 @default(false)
  trialStart           DateTime?                @db.Timestamptz(6)
  trialEnd             DateTime?                @db.Timestamptz(6)
  amount               String?
  applicantSub         ApplicantSubscription?
  institutionSub       InstitutionSubscription?

  @@map("StripePayment")
}

model InstitutionSubdiscipline {
  subdiscipline_id String       
  institution_id   String       
  add_at           DateTime      @db.Timestamptz(6)
  status           Boolean
  institution      Institution   @relation(fields: [institution_id], references: [institution_id], onDelete: NoAction, onUpdate: NoAction)
  subdiscipline    Subdiscipline @relation(fields: [subdiscipline_id], references: [subdiscipline_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([subdiscipline_id, institution_id])
  @@map("InstitutionSubdiscipline")
}

model SystemManager {
  manager_id   String               @id
  name         String
  phone_number String
  planMgmt     PlanManagement[]
  postMgmt     PostManagement[]
  supportReq   SupportRequirement[]
  userMgmt     UserManagement[]

  @@map("SystemManager")
}

model UserManagement {
  manager_id String       
  user_id    String       
  action     String
  update_at  DateTime      @db.Timestamptz(6)
  note       String?
  manager    SystemManager @relation(fields: [manager_id], references: [manager_id], onDelete: NoAction, onUpdate: NoAction)
  user       user          @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@id([manager_id, user_id, update_at])
  @@map("UserManagement")
}

model PostManagement {
  manager_id String         
  post_id    String         
  old_info   String
  new_info   String?
  action     String
  update_at  DateTime        @db.Timestamptz(6)
  note       String?
  manager    SystemManager   @relation(fields: [manager_id], references: [manager_id], onDelete: NoAction, onUpdate: NoAction)
  post       OpportunityPost @relation(fields: [post_id], references: [post_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([manager_id, post_id, update_at])
  @@map("PostManagement")
}

model PlanManagement {
  manager_id String       
  plan_id    String       
  old_info   String
  new_info   String?
  action     String
  update_at  DateTime      @db.Timestamptz(6)
  note       String?
  manager    SystemManager @relation(fields: [manager_id], references: [manager_id], onDelete: NoAction, onUpdate: NoAction)
  plan       Plan          @relation(fields: [plan_id], references: [plan_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([manager_id, plan_id, update_at])
  @@map("PlanManagement")
}

model SupportRequirement {
  support_id     String        @id @unique
  applicant_id   String?      
  institution_id String?      
  content        String
  create_at      DateTime      @db.Timestamptz(6)
  status         Boolean
  update_at      DateTime?     @db.Timestamptz(6)
  manager_id     String       
  applicant      Applicant?    @relation(fields: [applicant_id], references: [applicant_id], onDelete: NoAction, onUpdate: NoAction)
  institution    Institution?  @relation(fields: [institution_id], references: [institution_id], onDelete: NoAction, onUpdate: NoAction)
  manager        SystemManager @relation(fields: [manager_id], references: [manager_id], onDelete: NoAction, onUpdate: NoAction)

  @@index([applicant_id])
  @@index([institution_id])
  @@index([manager_id])
  @@index([status])
  @@index([create_at])
  @@map("SupportRequirement")
}

enum PostStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

enum ApplicationStatus {
  PENDING
  REVIEWED
  ACCEPTED
  REJECTED
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  EXPIRED
}
